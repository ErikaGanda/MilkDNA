---
title: "DNA Prep qPCR Data Analysis"
author: "ErikaGanda"
output:
  html_document: default
  pdf_document: default
  word_document: default
editor_options: 
  chunk_output_type: console
---
***
<style>
div.type0 { background-color:#BFBFBF; border-radius: 5px; padding: 20px;}
</style>
<div class = "type0">
<p style="color:white;font-size:60px;"> <b>Importing Main Dataset </b></p>
</div>

***
```{r}
#Data File: CleanDNAprepData1.18.19
library(ggplot2)
library(dplyr)
library(emmeans)
library(multcompView)

#Read Data
AllData <- read.table("CleanDNAprepData1.18.19.txt", sep="\t",  fill = TRUE, header=TRUE)
SampleData <- AllData %>% filter(VariableSampleType!="Standard", VariableSampleType!="NP40InoculatedMilk")
dim (SampleData)

write.table (SampleData, "SampleData.txt", sep="\t" )

#Getting All variables and all levels within each

#sapply(SampleData, levels)
#SampleData %>% 
#    sapply(levels)

#Summary Statistics
SampleData.summary <- SampleData %>%
  group_by(Assay,VariableKit,VariableSampleType) %>%
  summarize(mean_CopyN_permLMilk=mean(LogCopiespermLofMilk,na.rm=T),
            st_dev=sd(LogCopiespermLofMilk,na.rm=T),
            n_missing=sum(is.na(LogCopiespermLofMilk)),
            n_total=n())
write.table (SampleData.summary, "SampleData.summary.txt", sep="\t" ) 

SampleData.summary.by.replicate <- SampleData %>%
  group_by(Assay, SpikeSet, VariableKit) %>%
  summarize(mean_LogCopiespermLofMilk=mean(LogCopiespermLofMilk,na.rm=T),
            st_dev=sd(LogCopiespermLofMilk,na.rm=T),
            n_missing=sum(is.na(LogCopiespermLofMilk)),
            n_total=n())%>%
  data.frame()
write.table (SampleData.summary.by.replicate, "SampleData.summary.by.replicate.txt", sep="\t" )
```

***
<style>
div.type1 { background-color:#000000; border-radius: 5px; padding: 20px;}
</style>
<div class = "type1">
<p style="color:white;font-size:60px;"> <b> Bovine </i> </b></p>
</div>

***

# Total Bovine Copy Numbers
```{r}

#Filter Subset from Sample Data
Bovine <- SampleData %>% filter(Assay=="Bovine DNA")
dim(Bovine)

#Summary Statistics
Bovine.summary <- Bovine %>%
  group_by(VariableKit,VariableSampleType) %>%
  summarize(mean_CopyN_permLMilk=mean(LogCopiespermLofMilk,na.rm=T),
            st_dev=sd(LogCopiespermLofMilk,na.rm=T),
            n_missing=sum(is.na(LogCopiespermLofMilk)),
            n_total=n())
write.table (Bovine.summary, "Bovine.summary.txt", sep="\t" )
```

```{r}
#Plot Raw Means and Standard Deviations
Colors <- c("COREDNA" = "#4DB3C7", "EZFood"= "#85CA46", "Mastitis"= "#F49D00","Pfood"= "#D2338B", "PSoilP"="#1D6E9B", "PviralDNA"= "#6850B4", "ZymoDNA"="#165F05")
ggplot(data=Bovine,
       mapping=aes(x=VariableSampleType,y=LogCopiespermLofMilk,z=VariableKit, color=VariableKit)) +
  ylab ("Log10 Copies / mL of Milk")+
     geom_boxplot(lwd=1)+
  theme_bw()+
 ggtitle("Bovine DNA Copy Numbers")+
  scale_color_manual(values=Colors)+
  theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  theme(axis.text.x=element_text(angle=25,vjust=0.5))+
  scale_x_discrete(limits=c("UninoculatedMilk", "InoculatedMilk", "NP40InoculatedMilk",  "MockCommunity", "NoTemplateControl"))


ggplot(data=Bovine,
       mapping=aes(x=VariableSampleType,y=LogCopiespermLofMilk, color=VariableKit, shape=SpikeSet)) +
  ylab ("Log10 Copies / mL of Milk")+
    geom_jitter(width=0.25)+
  ggtitle("Bovine DNA Copy Numbers")+
  theme_bw()+
  scale_color_manual(values=Colors)+
  theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  theme(axis.text.x=element_text(angle=25,vjust=0.5))+
  scale_x_discrete(limits=c("UninoculatedMilk", "InoculatedMilk", "NP40InoculatedMilk",  "MockCommunity", "NoTemplateControl"))


```

```{r}
# Inoculated Milk Data
Bovine.InnOnly <- Bovine %>% filter(VariableSampleType=="InoculatedMilk", LogCopiespermLofMilk>0.001)
dim(Bovine.InnOnly)

Bovine.InnOnly %>%
  group_by(VariableKit) %>%
  summarize(mean_LogCopiespermLofMilk=mean(LogCopiespermLofMilk,na.rm=T),
            st_dev=sd(LogCopiespermLofMilk,na.rm=T),
            n_missing=sum(is.na(LogCopiespermLofMilk)),
            n_total=n())%>%
  data.frame()
####
Bovine.InnOnly.Summary = Bovine.InnOnly %>%
  group_by(VariableKit) %>%
  summarize(mean_LogCopiespermLofMilk=mean(LogCopiespermLofMilk,na.rm=T),
            st_dev=sd(LogCopiespermLofMilk,na.rm=T),
            n_missing=sum(is.na(LogCopiespermLofMilk)),
            n_total=n())%>%
  data.frame()

write.table (Bovine.InnOnly.Summary, "BovineInnOnly.summary.txt", sep="\t" )

write.table (Bovine.InnOnly, "BovineInnOnly.txt", sep="\t" )
 

Bovine.InnOnly %>%
  group_by(SpikeSet, VariableKit) %>%
  summarize(mean_LogCopiespermLofMilk=mean(LogCopiespermLofMilk,na.rm=T),
            st_dev=sd(LogCopiespermLofMilk,na.rm=T),
            n_missing=sum(is.na(LogCopiespermLofMilk)),
            n_total=n())%>%
  data.frame()


ggplot(data=Bovine.InnOnly,
       mapping=aes(x=VariableKit,y=LogCopiespermLofMilk, color=VariableKit, shape=SpikeSet)) +
  ylab ("Log10 Copies / mL of Milk")+
  xlab ("Kit")+
  geom_jitter(width=0.25)+
  ggtitle("Bovine DNA Copy Numbers - Inoculated Milk Only")+
  theme_bw()+
  scale_color_manual(values=Colors)+
  theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  theme(axis.text.x=element_text(angle=25,vjust=0.5))+
  scale_x_discrete(limits=c("COREDNA", "Mastitis", "EZFood",  "Pfood", "PSoilP", "PviralDNA", "ZymoDNA"))


ggplot(Bovine.InnOnly, aes(VariableKit,LogCopiespermLofMilk,shape = factor(SpikeSet))) +
  scale_shape_discrete(solid=F) +
  geom_jitter(aes(colour = VariableKit), size = 2,stroke = 1, width = .5) +
  ylab ("Log10 Copies / mL of Milk")+
  xlab ("Kit")+
  ggtitle("Bovine DNA Copy Numbers - Inoculated Milk Only")+
  theme_bw()+
  scale_color_manual(values=Colors)+
  theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  theme(axis.text.x=element_text(angle=25,vjust=0.5))+
  scale_x_discrete(limits=c("COREDNA", "Mastitis", "EZFood",  "Pfood", "PSoilP", "PviralDNA", "ZymoDNA"))


```

```{r}
# Model Selection

#3 linear models were compared: including SpikeSet only, qPCRefficiency only, and both as covariates. Best model fit was used as the final model. 

# Model 1 - VariableKit + SpikeSet
m_Bovine.LogCopiespermLofMilk1 <- lm( LogCopiespermLofMilk ~ VariableKit + SpikeSet, data=Bovine.InnOnly )
summary(m_Bovine.LogCopiespermLofMilk1)

# Model 2 - VariableKit + qPCRefficiency
m_Bovine.LogCopiespermLofMilk2 <- lm( LogCopiespermLofMilk ~ VariableKit + qPCRefficiency, data=Bovine.InnOnly )
summary(m_Bovine.LogCopiespermLofMilk2)

# Model 3 - VariableKit + qPCRefficiency + SpikeSet
m_Bovine.LogCopiespermLofMilk3 <- lm( LogCopiespermLofMilk ~ VariableKit + qPCRefficiency + SpikeSet, data=Bovine.InnOnly )
summary(m_Bovine.LogCopiespermLofMilk3)

anova(m_Bovine.LogCopiespermLofMilk1, m_Bovine.LogCopiespermLofMilk2)
# Model with qPCRefficiency does not have better fit than model with SpikeSet

anova(m_Bovine.LogCopiespermLofMilk2, m_Bovine.LogCopiespermLofMilk3)
# Model with both qPCRefficiency and SpikeSet does not have better fit than model with qPCRefficiency only

anova(m_Bovine.LogCopiespermLofMilk1, m_Bovine.LogCopiespermLofMilk3)
# Model with both qPCRefficiency and SpikeSet does not have better fit than model with SpikeSet only

# Fit of model with both qPCRefficiency and SpikeSet is not different from fit of model with SpikeSet only
anova(m_Bovine.LogCopiespermLofMilk1, m_Bovine.LogCopiespermLofMilk2, m_Bovine.LogCopiespermLofMilk3)

#m_Bovine.LogCopiespermLofMilk1 <- lm( LogCopiespermLofMilk ~ VariableKit + SpikeSet, data=Bovine.InnOnly )
AIC (m_Bovine.LogCopiespermLofMilk1)

#m_Bovine.LogCopiespermLofMilk2 <- lm( LogCopiespermLofMilk ~ VariableKit + qPCRefficiency, data=Bovine.InnOnly )
AIC (m_Bovine.LogCopiespermLofMilk2)

#m_Bovine.LogCopiespermLofMilk3 <- lm( LogCopiespermLofMilk ~ VariableKit + qPCRefficiency + SpikeSet, data=Bovine.InnOnly )
AIC (m_Bovine.LogCopiespermLofMilk3)

# Final model chosen:
# Model 1: LogCopiespermLofMilk ~ VariableKit + SpikeSet
```
### Chosen Linear Model

```{r}
# Fit Linear Model

m_Bovine.LogCopiespermLofMilk <- lm( LogCopiespermLofMilk ~ VariableKit + SpikeSet, data=Bovine.InnOnly )
summary(m_Bovine.LogCopiespermLofMilk)

# Model Fit Plots

plot(x=predict(m_Bovine.LogCopiespermLofMilk),y=resid(m_Bovine.LogCopiespermLofMilk))
  
  # using ggplot2
Colors <- c("COREDNA" = "#4DB3C7", "EZFood"= "#85CA46", "Mastitis"= "#F49D00","Pfood"= "#D2326B", "PSoilP"="#1D6E9B", "PviralDNA"= "#6850B4", "ZymoDNA"="#165F05")

ggplot(m_Bovine.LogCopiespermLofMilk, aes(x=predict(m_Bovine.LogCopiespermLofMilk), y=resid(m_Bovine.LogCopiespermLofMilk), color=VariableKit)) +
  geom_point()+
  theme_bw()+
  ggtitle("Bovine Innoculated Only - Model Fit - Residuals vs Predicted")+
  scale_color_manual(values=Colors)+
  theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  geom_hline(yintercept = 1) +
  geom_hline(yintercept = -1)

  # qqplots
qqnorm(resid(m_Bovine.LogCopiespermLofMilk))
qqline(resid(m_Bovine.LogCopiespermLofMilk))

summary(m_Bovine.LogCopiespermLofMilk)

#Almost all residuals are < 1. 
#Exceptions are:

Bovine.InnOnly$resid <- resid(m_Bovine.LogCopiespermLofMilk)
Bovine.InnOnly %>% 
  filter(abs(resid)>1) %>%
  select(VariableKit,resid) %>%
  group_by(VariableKit) %>%
  summarize(n=n())

```

```{r}
library(emmeans)
# Check Tukey-adjusted pairwise comparison of kit estimates
m_Bovine.LogCopiespermLofMilk_emmeans <- emmeans(m_Bovine.LogCopiespermLofMilk,pairwise~VariableKit)
# Use compact letter display for convenience
m_Bovine.LogCopiespermLofMilk_cld <- CLD(m_Bovine.LogCopiespermLofMilk_emmeans$emmeans,
                         Letters=LETTERS)
m_Bovine.LogCopiespermLofMilk_cld
m_Bovine.LogCopiespermLofMilk_cld_detail <- CLD(m_Bovine.LogCopiespermLofMilk_emmeans$emmeans, sort=TRUE, details=TRUE, Letters=LETTERS)
m_Bovine.LogCopiespermLofMilk_cld_detail

# Get fitted values from model to plot with other software
emmeans(m_Bovine.LogCopiespermLofMilk,~ VariableKit) %>%
  summary() %>%
  data.frame() 

# Get summary
summary(emmeans(m_Bovine.LogCopiespermLofMilk,~ VariableKit), infer=TRUE)

# Plot fitted values from model
Colors <- c("COREDNA" = "#4DB3C7", "EZFood"= "#85CA46", "Mastitis"= "#F49D00","Pfood"= "#D2326B", "PSoilP"="#1D6E9B", "PviralDNA"= "#6850B4", "ZymoDNA"="#165F05")
emmeans(m_Bovine.LogCopiespermLofMilk,~VariableKit) %>%
  summary() %>%
  data.frame() %>%

  ggplot(aes(x=VariableKit,y=emmean,color=VariableKit)) +
  geom_point() +
  labs(y="Estimated Marginal Means") +
  geom_errorbar(aes(ymin=lower.CL,ymax=upper.CL),width=0.5) +
  geom_text(data =data.frame(m_Bovine.LogCopiespermLofMilk_cld),aes(x=VariableKit,label=`.group`),hjust=-.1) +
 ylim(3.5, 8.5)+
  theme_bw()+
 ggtitle("Bovine Copy Numbers - Inoculated Milk Only")+
  scale_color_manual(values=Colors)+
  theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  theme(axis.text.x=element_text(angle=25,vjust=0.5))+
scale_x_discrete(limits=c("COREDNA", "Mastitis", "EZFood",  "Pfood", "PSoilP", "PviralDNA", "ZymoDNA"))

```


```{r}
### Figure: Bovine InnOnly Raw Data + Final Model Output

df1_Bovine.rawdata<-Bovine.InnOnly[c(25,42,4)]

df2_Bovine.model<-emmeans(m_Bovine.LogCopiespermLofMilk,~VariableKit) %>%
  summary() %>%
  data.frame()

ggplot() +
  geom_jitter(data=df1_Bovine.rawdata,aes(x=VariableKit,y=LogCopiespermLofMilk)) +
  geom_point(data=df2_Bovine.model,aes(x=VariableKit,y=emmean,fill=VariableKit))+
  geom_errorbar(data=df2_Bovine.model,aes(x=VariableKit,ymin=lower.CL,ymax=upper.CL),width=0.5)
  
# Making the plot pretty

Colors <- c("COREDNA" = "#4DB3C7", "EZFood"= "#85CA46", "Mastitis"= "#F49D00","Pfood"= "#D2326B", "PSoilP"="#1D6E9B", "PviralDNA"= "#6850B4", "ZymoDNA"="#165F05")
  
ggplot() +
  geom_jitter(data=df1_Bovine.rawdata,aes(x=VariableKit,y=LogCopiespermLofMilk,color=VariableKit, shape=SpikeSet)) +
  scale_color_manual(values=Colors)+
  geom_point(data=df2_Bovine.model,aes(x=VariableKit,y=emmean,fill=VariableKit))+
  geom_errorbar(data=df2_Bovine.model,aes(x=VariableKit,ymin=lower.CL,ymax=upper.CL),width=0.5)+  
  geom_text(data =data.frame(m_Bovine.LogCopiespermLofMilk_cld),aes(x=VariableKit,label=`.group`, y=emmean),hjust=-.5) +
ylim(3.5, 6.5)+
xlab("Kit")+
ylab ("Log10 Copies / mL of Milk")+
  theme_bw()+
  ggtitle("Bovine Copy Numbers - Inoculated Milk Only")+
  scale_color_manual(values=Colors)+
  theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  theme(axis.text.x=element_text(angle=25,vjust=0.5))+
scale_x_discrete(limits=c("COREDNA", "Mastitis", "EZFood",  "Pfood", "PSoilP", "PviralDNA", "ZymoDNA"))

```

## Bovine - Models not assuming homoscedasticity

```{r}
# from https://cran.r-project.org/web/packages/emmeans/vignettes/FAQs.html#contents

library(nlme)
# lm chosen: m_Bovine.LogCopiespermLofMilk <- lm( LogCopiespermLofMilk ~ VariableKit + SpikeSet, data=Bovine.InnOnly )

mod.Bovine = nlme::gls(LogCopiespermLofMilk ~ VariableKit + SpikeSet, data = Bovine.InnOnly,
                 weights = varIdent(form = ~1 | VariableKit))
summary(mod.Bovine)

AIC(mod.Bovine)

# Model forcing qPCRefficiency


mod.Bovine.all = nlme::gls(LogCopiespermLofMilk ~ VariableKit + SpikeSet+qPCRefficiency, data = Bovine.InnOnly,
                 weights = varIdent(form = ~1 | VariableKit))
summary(mod.Bovine.all)

AIC(mod.Bovine.all)

# It is not possible to fit model with interactions because of dropout (failure to amplify in some samples). Gls does not tolerate missing cells in interaction terms.

# Testing simpler model

mod3 = nlme::gls(LogCopiespermLofMilk ~ VariableKit, data = Bovine.InnOnly,
                 weights = varIdent(form = ~1 | VariableKit))
summary(mod3)

AIC(mod.Bovine)
AIC(mod.Bovine.all) # best model
AIC(mod3) 

mod.Bovine.best <- mod.Bovine.all
AIC (mod.Bovine.best)

AIC (m_Bovine.LogCopiespermLofMilk)
AIC (mod3)
summary(mod3)
summary(m_Bovine.LogCopiespermLofMilk)

#model not assuming homoscedasticity and including VariableKit + SpikeSet + qPCRefficiency is a much better fit than any of the alternatives

  # qqplots
qqnorm(resid(m_Bovine.LogCopiespermLofMilk))
qqline(resid(m_Bovine.LogCopiespermLofMilk))

qqnorm(resid(mod.Bovine.best))
qqline(resid(mod.Bovine.best))

```

### Bovine Figure
```{r}
library(emmeans)
# Check Tukey-adjusted pairwise comparison of kit estimates
mod.Bovine.best_emmeans <- emmeans(mod.Bovine.best,pairwise~VariableKit, mode = "df.error")

# Use compact letter display for convenience
mod.Bovine.best_cld <- CLD(mod.Bovine.best_emmeans$emmeans, sort=TRUE, details=TRUE, Letters=LETTERS)
mod.Bovine.best_cld_letters <- CLD(mod.Bovine.best_emmeans$emmeans, Letters=LETTERS)
mod.Bovine.best_cld_letters

# Get fitted values from model to plot with other software
emmeans(mod.Bovine.best,~ VariableKit,mode = "df.error") %>%
  summary() %>%
  data.frame() 

# Get summary
summary(emmeans(mod.Bovine.best,~ VariableKit,mode = "df.error"), infer=TRUE)

# Plot overlaying model estimates to raw data
mod_df1_Bovine.rawdata<-Bovine.InnOnly[c(25,42,4)]

mod_df2_Bovine.best.model<-emmeans(mod.Bovine.best,~VariableKit, mode = "df.error") %>%
  summary() %>%
  data.frame()

ggplot() +
  geom_jitter(data=mod_df1_Bovine.rawdata,aes(x=VariableKit,y=LogCopiespermLofMilk)) +
  geom_point(data=mod_df2_Bovine.best.model,aes(x=VariableKit,y=emmean,fill=VariableKit))+
  geom_errorbar(data=mod_df2_Bovine.best.model,aes(x=VariableKit,ymin=lower.CL,ymax=upper.CL),width=0.5)

# Making the plot pretty

Colors <- c("COREDNA" = "#4DB3C7", "EZFood"= "#85CA46", "Mastitis"= "#F49D00","Pfood"= "#D2326B", "PSoilP"="#1D6E9B", "PviralDNA"= "#6850B4", "ZymoDNA"="#165F05")
  
ggplot() +
  geom_jitter(data=mod_df1_Bovine.rawdata,aes(x=VariableKit,y=LogCopiespermLofMilk,color=VariableKit, shape=SpikeSet)) +
  scale_color_manual(values=Colors)+
  geom_errorbar(data=mod_df2_Bovine.best.model,aes(x=VariableKit,ymin=lower.CL,ymax=upper.CL),width=0.3)+  
  geom_point(data=mod_df2_Bovine.best.model,aes(x=VariableKit,y=emmean,fill=VariableKit))+
  geom_text(data =data.frame(mod.Bovine.best_cld_letters),aes(x=VariableKit,label=`.group`, y=emmean), nudge_y = 0.2, nudge_x = -0.05, fontface = "bold") +
#ylim(3.5, 6.5)+
xlab("Kit")+
ylab ("Log10 Copies / mL of Milk")+
  theme_bw()+
  ggtitle("Bovine Copy Numbers - Inoculated Milk Only - Not assuming homoscedasticity ")+
  scale_color_manual(values=Colors)+
  theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  theme(axis.text.x=element_text(angle=25,vjust=0.5))+
scale_x_discrete(limits=c("COREDNA", "Mastitis", "EZFood",  "Pfood", "PSoilP", "PviralDNA", "ZymoDNA"))

```


***
<style>
div.type0 { background-color:#BFBFBF; border-radius: 5px; padding: 20px;}
</style>
<div class = "type0">
<p style="color:black;font-size:15px;"> <b> 
Model not assuming homoscedasticity and including VariableKit + SpikeSet + qPCRefficiency was chosen.<br> qPCRefficiency is forced into all final models </b>

Formula: mod.Bovine.all = nlme::gls(LogCopiespermLofMilk ~ VariableKit + SpikeSet + qPCRefficiency, data = Bovine.InnOnly,weights = varIdent(form = ~1 | VariableKit))<br>
<br>
<b> AIC(mod.Bovine.all) # best model<br>
 -134.968 <br> </b>
 <br>
<br>
Other Models for Reference: <br>
<br>
mod.Bovine = nlme::gls(LogCopiespermLofMilk ~ VariableKit + SpikeSet, data = Bovine.InnOnly,
                 weights = varIdent(form = ~1 | VariableKit))<br>
AIC(mod.Bovine)<br>
 -128.8078<br>
 <br>

 mod3 = nlme::gls(LogCopiespermLofMilk ~ VariableKit, data = Bovine.InnOnly,
                 weights = varIdent(form = ~1 | VariableKit))<br>
AIC(mod3) <br>
 -131.4578<br>
<br>

Previously chosen Linear Model that assumed homoscedasticity for reference: <br>
m_Bovine.LogCopiespermLofMilk <- lm( LogCopiespermLofMilk ~ VariableKit + SpikeSet, data=Bovine.InnOnly ) <br>
AIC(m_Bovine.LogCopiespermLofMilk) <br>
 -13.54697 <br>

</p>
</div>

***


***
<style>
div.type2 { background-color:#66C2A5; border-radius: 15px; padding: 20px;}
</style>
<div class = "type2">
<p style="color:black;font-size:20px;"> <b>Manuscript Figures: Bovine </b></p>
</div>

***

```{r}
# Bovine: Milk Data and Controls
Bovine.Inn.Ctrl <- Bovine %>% filter(VariableSampleType!="NP40InoculatedMilk")
dim(Bovine.Inn.Ctrl)

Colors <- c("COREDNA" = "#4DB3C7", "EZFood"= "#85CA46", "Mastitis"= "#F49D00","Pfood"= "#D2338B", "PSoilP"="#1D6E9B", "PviralDNA"= "#6850B4", "ZymoDNA"="#165F05")


Bovine.Inn.Ctrl$VariableSampleType <- factor(Bovine.Inn.Ctrl$VariableSampleType, levels=c('InoculatedMilk', 'UninoculatedMilk', 'NoTemplateControl', 'MockCommunity'))

ggplot(data=Bovine.Inn.Ctrl, aes(VariableKit,LogCopiespermLofMilk, color= VariableKit, shape=SpikeSet), show.legend = F)+
  scale_shape_discrete(solid=F) +
  ylab ("Bovine Log10 Copies / mL of Milk")+  
  xlab ("Kit")+
  geom_point(aes(colour = VariableKit), size = 2, stroke = .5, position=position_jitterdodge(jitter.width=0, dodge.width = 1), show.legend = F) +
  facet_wrap(vars(VariableSampleType),nrow = 1)+
  ggtitle("Bovine DNA Copy Numbers - All Samples and Controls")+
  theme_bw()+
  ylim(0, 9)+
  scale_color_manual(values=Colors)+
  theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  theme(axis.text.x=element_text(angle=90,vjust=0.5))+
  scale_x_discrete(limits=c("COREDNA", "Mastitis", "EZFood",  "Pfood", "PSoilP", "PviralDNA", "ZymoDNA"))

ggsave("Bovine-AllSamples.TIFF", width = 9, height = 3,units = "in", dpi = 600)

ggplot(Bovine.InnOnly, aes(VariableKit,LogCopiespermLofMilk,shape = factor(SpikeSet))) +
  scale_shape_discrete(solid=F) +
  geom_point(aes(colour = VariableKit), size = 2, stroke = 1, position=position_jitterdodge(jitter.width=0, dodge.width = 1)) +
  ylab ("Log10 Copies / mL of Milk")+
  xlab ("Kit")+
  ggtitle("Bovine DNA Copy Numbers - Inoculated Milk Only")+
  theme_bw()+
  scale_color_manual(values=Colors)+
  theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  theme(axis.text.x=element_text(angle=25,vjust=0.5))+
  scale_x_discrete(limits=c("COREDNA", "Mastitis", "EZFood",  "Pfood", "PSoilP", "PviralDNA", "ZymoDNA"))
```

```{r}
# Plot overlaying model estimates to raw data
mod_df1_Bovine.rawdata<-Bovine.InnOnly[c(25,42,4)]

mod_df2_Bovine.best.model<-emmeans(mod3,~VariableKit, mode = "df.error") %>%
  summary() %>%
  data.frame()

ggplot() +
  geom_jitter(data=mod_df1_Bovine.rawdata,aes(x=VariableKit,y=LogCopiespermLofMilk,color=VariableKit, shape=SpikeSet), size = 2,stroke = 1, width = .2 ) +
   scale_shape_discrete(solid=F) +
  scale_color_manual(values=Colors)+
  geom_errorbar(data=mod_df2_Bovine.best.model,aes(x=VariableKit,ymin=lower.CL,ymax=upper.CL),width=0.3)+  
  geom_point(data=mod_df2_Bovine.best.model,aes(x=VariableKit,y=emmean,fill=VariableKit))+
  geom_text(data =data.frame(mod.Bovine.best_cld_letters),aes(x=VariableKit,label=`.group`, y=emmean), nudge_y = 0.7, nudge_x = -0.05, fontface = "bold") +
ylim(3, 6.5)+
ylab ("Log10 Copies / mL of Milk")+
  xlab ("Kit")+
  ggtitle("Bovine DNA Copy Numbers - Inoculated Milk Only")+
   theme_bw()+
   theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  scale_x_discrete(limits=c("COREDNA", "Mastitis", "EZFood",  "Pfood", "PSoilP", "PviralDNA", "ZymoDNA"))

ggsave("Bovine-Model-Jitter.TIFF", width = 7.5, height = 3.5 , units = "in", dpi = 600)


ggplot() +
  geom_point(data=mod_df1_Bovine.rawdata,aes(x=VariableKit,y=LogCopiespermLofMilk,color=VariableKit, shape=SpikeSet), size = 2, stroke = 1, position=position_jitterdodge(jitter.width=0, dodge.width = .5)) +
   scale_shape_discrete(solid=F) +
  scale_color_manual(values=Colors)+
  geom_errorbar(data=mod_df2_Bovine.best.model,aes(x=VariableKit,ymin=lower.CL,ymax=upper.CL),width=0.3)+  
  geom_point(data=mod_df2_Bovine.best.model,aes(x=VariableKit,y=emmean,fill=VariableKit))+
  geom_text(data =data.frame(mod.Bovine.best_cld_letters),aes(x=VariableKit,label=`.group`, y=emmean), nudge_y = .7, nudge_x = -0.05, fontface = "bold") +
ylim(3, 6.5)+
ylab ("Log10 Copies / mL of Milk")+
  xlab ("Kit")+
  ggtitle("Bovine DNA Copy Numbers - Inoculated Milk Only")+
   theme_bw()+
   theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  scale_x_discrete(limits=c("COREDNA", "Mastitis", "EZFood",  "Pfood", "PSoilP", "PviralDNA", "ZymoDNA"))
ggsave("Bovine-Model.TIFF", width = 7.5, height = 3.5 , units = "in", dpi = 600)
```

***
<style>
div.type1 { background-color:#000000; border-radius: 5px; padding: 20px;}
</style>
<div class = "type1">
<p style="color:white;font-size:60px;"> <b>Total Bacterial DNA </b></p>
</div>

***
#Total Bacterial DNA
```{r}
#Data File: CleanDNAprepData1.18.19
library(ggplot2)
library(dplyr)
library(emmeans)
library(multcompView)

#Filter Subset from Sample Data
TotalBacterialDNA <- SampleData %>% filter(Assay=="Total Bacterial DNA")
dim(TotalBacterialDNA)

#Summary Statistics

TotalBacterialDNA.summary <- TotalBacterialDNA %>%
  group_by(VariableKit,VariableSampleType) %>%
  summarize(mean_LogCopiespermLofMilk=mean(LogCopiespermLofMilk,na.rm=T),
            st_dev=sd(LogCopiespermLofMilk,na.rm=T),
            n_missing=sum(is.na(LogCopiespermLofMilk)),
            n_total=n())%>%
  data.frame()
  
write.table (TotalBacterialDNA.summary, "TotalBacterialDNA.summary.txt", sep="\t" )
```

```{r}
#Plot Raw Means and Standard Deviations
Colors <- c("COREDNA" = "#4DB3C7", "EZFood"= "#85CA46", "Mastitis"= "#F49D00","Pfood"= "#D2326B", "PSoilP"="#1D6E9B", "PviralDNA"= "#6850B4", "ZymoDNA"="#165F05")
ggplot(data=TotalBacterialDNA,
       mapping=aes(x=VariableSampleType,y=LogCopiespermLofMilk,z=VariableKit, color=VariableKit, ylab="Copy Numbers")) +
  ylab ("Log10 Copies / mL of Milk")+
  geom_boxplot(lwd=1)+
  theme_bw()+
  ggtitle("TotalBacterialDNA Copy Numbers")+
  scale_color_manual(values=Colors)+
  theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  theme(axis.text.x=element_text(angle=25,vjust=0.5))+
  scale_x_discrete(limits=c("UninoculatedMilk", "InoculatedMilk", "NP40InoculatedMilk",  "MockCommunity", "NoTemplateControl"))




ggplot(data=TotalBacterialDNA,
       mapping=aes(x=VariableSampleType,y=LogCopiespermLofMilk, color=VariableKit, shape=SpikeSet)) +
  ylab ("Log10 Copies / mL of Milk")+
      geom_jitter(width=0.25)+
  ggtitle("TotalBacterialDNA Copy Numbers")+
  theme_bw()+
  scale_color_manual(values=Colors)+
  theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  theme(axis.text.x=element_text(angle=25,vjust=0.5))+
  scale_x_discrete(limits=c("UninoculatedMilk", "InoculatedMilk", "NP40InoculatedMilk",  "MockCommunity", "NoTemplateControl"))



ggplot(data=TotalBacterialDNA,
       mapping=aes(x=VariableSampleType,y=LogCopiespermLofMilk, color=SpikeSet, shape=VariableKit)) +
  ylab ("Log10 Copies / mL of Milk")+
    geom_jitter(width=0.35)+
  ggtitle("TotalBacterialDNA Copy Numbers")+
  theme_bw()+
  theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  theme(axis.text.x=element_text(angle=25,vjust=0.5))+
  scale_x_discrete(limits=c("UninoculatedMilk", "InoculatedMilk", "NP40InoculatedMilk",  "MockCommunity", "NoTemplateControl"))

```

```{r}
# Milk Data and Controls
TotalBacterialDNA.Inn.Ctrl <- TotalBacterialDNA %>% filter(VariableSampleType!="NP40InoculatedMilk")
dim(TotalBacterialDNA.Inn.Ctrl)

Colors <- c("COREDNA" = "#4DB3C7", "EZFood"= "#85CA46", "Mastitis"= "#F49D00","Pfood"= "#D2338B", "PSoilP"="#1D6E9B", "PviralDNA"= "#6850B4", "ZymoDNA"="#165F05")


TotalBacterialDNA.Inn.Ctrl$VariableSampleType <- factor(TotalBacterialDNA.Inn.Ctrl$VariableSampleType, levels=c('InoculatedMilk', 'UninoculatedMilk', 'NoTemplateControl', 'MockCommunity'))

 ggplot(data=TotalBacterialDNA.Inn.Ctrl, aes(VariableKit,LogCopiespermLofMilk, color= VariableKit, shape=SpikeSet),show.legend = F)+
   scale_shape_discrete(solid=F) +
     ylab ("Bacteria Log10 Copies / mL of Milk")+
    geom_jitter(width=0.25, size=2.5, stroke=0.7)+
  facet_wrap(vars(VariableSampleType),nrow = 1)+
    ggtitle("Bacteria DNA Copy Numbers - All Samples and Controls")+
  theme_bw()+
  ylim(0, 9)+
  scale_color_manual(values=Colors)+
  theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  theme(axis.text.x=element_text(angle=25,vjust=0.5))+
  scale_x_discrete(limits=c("COREDNA", "Mastitis", "EZFood",  "Pfood", "PSoilP", "PviralDNA", "ZymoDNA"))
```

```{r}
# Inoculated Milk Data
TotalBacterialDNA.InnOnly <- TotalBacterialDNA %>% filter(VariableSampleType=="InoculatedMilk", LogCopiespermLofMilk>0.001)
TotalBacterialDNA.InnOnly %>%
  group_by(VariableSampleType, VariableSpikeSet, VariableKit) %>%
  summarize(mean_LogCopiespermLofMilk=mean(LogCopiespermLofMilk,na.rm=T),
            st_dev=sd(LogCopiespermLofMilk,na.rm=T),
            n_missing=sum(is.na(LogCopiespermLofMilk)),
            n_total=n())%>%
  data.frame()
```
## Model Selection
### Linear Models
```{r}
#3 linear models were compared: including SpikeSet only, qPCRefficiency only, and both as covariates. Best model fit was used as the final model. 
m_TotalBacterialDNA.LogCopiespermLofMilk1 <- lm( LogCopiespermLofMilk ~ VariableKit + SpikeSet, data=TotalBacterialDNA.InnOnly )
summary(m_TotalBacterialDNA.LogCopiespermLofMilk1)

m_TotalBacterialDNA.LogCopiespermLofMilk2 <- lm( LogCopiespermLofMilk ~ VariableKit + qPCRefficiency, data=TotalBacterialDNA.InnOnly )
summary(m_TotalBacterialDNA.LogCopiespermLofMilk2)

m_TotalBacterialDNA.LogCopiespermLofMilk3 <- lm( LogCopiespermLofMilk ~ VariableKit + qPCRefficiency + SpikeSet, data=TotalBacterialDNA.InnOnly )
summary(m_TotalBacterialDNA.LogCopiespermLofMilk3)

anova(m_TotalBacterialDNA.LogCopiespermLofMilk1, m_TotalBacterialDNA.LogCopiespermLofMilk2, m_TotalBacterialDNA.LogCopiespermLofMilk3)
# Model with qPCRefficiency does not have better fit than model with SpikeSet

AIC(m_TotalBacterialDNA.LogCopiespermLofMilk1)
AIC(m_TotalBacterialDNA.LogCopiespermLofMilk2)
AIC(m_TotalBacterialDNA.LogCopiespermLofMilk3)

# Final model chosen:
# Model 1: LogCopiespermLofMilk ~ VariableKit + SpikeSet
# No ddifference in fit, simplest model chosen
```

### Mixed effects models - for reference - AIC of linear models is smaller
```{r}
library(lme4)
library(lmerTest)

model1 = lmer(LogCopiespermLofMilk ~ VariableKit + (1|SpikeSet),
            data=TotalBacterialDNA.InnOnly,
            REML=TRUE)
summary(model1)

model2 = lmer(LogCopiespermLofMilk ~ VariableKit + qPCRefficiency + (1|SpikeSet),
            data=TotalBacterialDNA.InnOnly,
            REML=TRUE)
summary(model2)

anova(model1, model2)
AIC (model1)
AIC (model2)
```

## Final Model

```{r}
m_TotalBacterialDNA.LogCopiespermLofMilk <- lm( LogCopiespermLofMilk ~ VariableKit + SpikeSet, data=TotalBacterialDNA.InnOnly )
summary(m_TotalBacterialDNA.LogCopiespermLofMilk)


plot(x=predict(m_TotalBacterialDNA.LogCopiespermLofMilk),y=resid(m_TotalBacterialDNA.LogCopiespermLofMilk))

  # using ggplot2
Colors <- c("COREDNA" = "#4DB3C7", "EZFood"= "#85CA46", "Mastitis"= "#F49D00","Pfood"= "#D2326B", "PSoilP"="#1D6E9B", "PviralDNA"= "#6850B4", "ZymoDNA"="#165F05")
 
ggplot(m_TotalBacterialDNA.LogCopiespermLofMilk, aes(x=predict(m_TotalBacterialDNA.LogCopiespermLofMilk), y=resid(m_TotalBacterialDNA.LogCopiespermLofMilk), color=VariableKit)) +
  geom_point()+
  theme_bw()+
  ggtitle("Total Bacterial DNA Innoculated Only - Model Fit - Residuals vs Predicted")+
  scale_color_manual(values=Colors)+
  theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  geom_hline(yintercept = 1) +
  geom_hline(yintercept = -1)

  # qqplots
qqnorm(resid(m_TotalBacterialDNA.LogCopiespermLofMilk))
qqline(resid(m_TotalBacterialDNA.LogCopiespermLofMilk))
summary(m_TotalBacterialDNA.LogCopiespermLofMilk)

#Many large residuals were identified, most belong to EZFood

TotalBacterialDNA.InnOnly$resid <- resid(m_TotalBacterialDNA.LogCopiespermLofMilk)
TotalBacterialDNA.InnOnly %>% 
  filter(abs(resid)>1) %>%
  select(VariableKit,resid) %>%
  group_by(VariableKit) %>%
  summarize(n=n())

```

```{r}
# Check Tukey-adjusted pairwise comparison of kit estimates
m_TotalBacterialDNA.LogCopiespermLofMilk_emmeans <- emmeans(m_TotalBacterialDNA.LogCopiespermLofMilk,pairwise~VariableKit)
# Use compact letter display for convenience
m_TotalBacterialDNA.LogCopiespermLofMilk_cld <- CLD(m_TotalBacterialDNA.LogCopiespermLofMilk_emmeans$emmeans,
                                         Letters=LETTERS)
m_TotalBacterialDNA.LogCopiespermLofMilk_cld

# Get fitted values from model to plot with other software
emmeans(m_TotalBacterialDNA.LogCopiespermLofMilk,~ VariableKit) %>%
  summary() %>%
  data.frame() 

# Plot fitted values from model
Colors <- c("COREDNA" = "#4DB3C7", "EZFood"= "#85CA46", "Mastitis"= "#F49D00","Pfood"= "#D2326B", "PSoilP"="#1D6E9B", "PviralDNA"= "#6850B4", "ZymoDNA"="#165F05")
emmeans(m_TotalBacterialDNA.LogCopiespermLofMilk,~VariableKit) %>%
  summary() %>%
  data.frame() %>%
  ggplot(aes(x=VariableKit,y=emmean,color=VariableKit)) +
  geom_point() +
  labs(y="Estimated Marginal Means") +
  geom_errorbar(aes(ymin=lower.CL,ymax=upper.CL),width=0.5) +
  geom_text(data=data.frame(m_TotalBacterialDNA.LogCopiespermLofMilk_cld),aes(x=VariableKit,label=`.group`),hjust=-.1) +
 ylim(3.5, 8.5)+
  theme_bw()+
  ggtitle("Total 16S Bacterial DNA Copy Numbers - Inoculated Milk Only")+
  scale_color_manual(values=Colors)+
  theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  theme(axis.text.x=element_text(angle=25,vjust=0.5))+
  scale_x_discrete(limits=c("COREDNA", "Mastitis", "EZFood",  "Pfood", "PSoilP", "PviralDNA", "ZymoDNA"))

```


## TotalBacteria - Models not assuming homoscedasticity

```{r}
# from https://cran.r-project.org/web/packages/emmeans/vignettes/FAQs.html#contents

library(nlme)
# lm chosen: Model 1: LogCopiespermLofMilk ~ VariableKit + SpikeSet

mod.Bacteria = nlme::gls(LogCopiespermLofMilk ~ VariableKit + SpikeSet, data=TotalBacterialDNA.InnOnly,
                 weights = varIdent(form = ~1 | VariableKit))
summary(mod.Bacteria)

AIC(m_TotalBacterialDNA.LogCopiespermLofMilk1)
AIC(mod.Bacteria)

# Testing simpler model

mod3.Bacteria = nlme::gls(LogCopiespermLofMilk ~ VariableKit, data=TotalBacterialDNA.InnOnly,
                 weights = varIdent(form = ~1 | VariableKit))
summary(mod3.Bacteria)

AIC(m_TotalBacterialDNA.LogCopiespermLofMilk1)
AIC(mod.Bacteria) #mod.Bacteria is best model (including SpikeSet)
AIC(mod3.Bacteria) 

# Model forcing qPCRefficiency

mod.Bacteria.all = nlme::gls(LogCopiespermLofMilk ~ VariableKit + SpikeSet+qPCRefficiency, data = TotalBacterialDNA.InnOnly,
                 weights = varIdent(form = ~1 | VariableKit))
summary(mod.Bacteria.all)
AIC(mod.Bacteria.all)
#mod.Bacteria.all not assuming homoscedasticity and including SpikeSet and qPCRefficiency is a better fit

mod.Bacteria.best <- mod.Bacteria.all
AIC(mod.Bacteria.best)
```

### Bacteria Figure
```{r}
library(emmeans)
# Check Tukey-adjusted pairwise comparison of kit estimates
mod.Bacteria.best_emmeans <- emmeans(mod.Bacteria.best,pairwise~VariableKit, mode = "df.error")

# Use compact letter display for convenience
mod.Bacteria.best_cld <- CLD(mod.Bacteria.best_emmeans$emmeans, sort=TRUE, details=TRUE, Letters=LETTERS)
mod.Bacteria.best_cld_letters <- CLD(mod.Bacteria.best_emmeans$emmeans, Letters=LETTERS)
mod.Bacteria.best_cld_letters

# Get fitted values from model to plot with other software
emmeans(mod.Bacteria.best,~ VariableKit,mode = "df.error") %>%
  summary() %>%
  data.frame() 

# Get summary
summary(emmeans(mod.Bacteria.best,~ VariableKit,mode = "df.error"), infer=TRUE)

# Plot overlaying model estimates to raw data
mod_df1_Bacteria.rawdata<-TotalBacterialDNA.InnOnly[c(25,42,4)]

mod_df2_Bacteria.best.model<-emmeans(mod.Bacteria.best,~VariableKit, mode = "df.error") %>%
  summary() %>%
  data.frame()

ggplot() +
  geom_jitter(data=mod_df1_Bacteria.rawdata,aes(x=VariableKit,y=LogCopiespermLofMilk)) +
  geom_point(data=mod_df2_Bacteria.best.model,aes(x=VariableKit,y=emmean,fill=VariableKit))+
  geom_errorbar(data=mod_df2_Bacteria.best.model,aes(x=VariableKit,ymin=lower.CL,ymax=upper.CL),width=0.5)

# Making the plot pretty

Colors <- c("COREDNA" = "#4DB3C7", "EZFood"= "#85CA46", "Mastitis"= "#F49D00","Pfood"= "#D2326B", "PSoilP"="#1D6E9B", "PviralDNA"= "#6850B4", "ZymoDNA"="#165F05")
  
ggplot() +
  geom_jitter(data=mod_df1_Bacteria.rawdata,aes(x=VariableKit,y=LogCopiespermLofMilk,color=VariableKit, shape=SpikeSet)) +
  scale_color_manual(values=Colors)+
  geom_errorbar(data=mod_df2_Bacteria.best.model,aes(x=VariableKit,ymin=lower.CL,ymax=upper.CL),width=0.3)+  
  geom_point(data=mod_df2_Bacteria.best.model,aes(x=VariableKit,y=emmean,fill=VariableKit))+
  geom_text(data =data.frame(mod.Bacteria.best_cld_letters),aes(x=VariableKit,label=`.group`, y=emmean), nudge_y = 0.2, nudge_x = -0.05, fontface = "bold") +
#ylim(3.5, 6.5)+
xlab("Kit")+
ylab ("Log10 Copies / mL of Milk")+
  theme_bw()+
  ggtitle("Bacteria Copy Numbers - Inoculated Milk Only - Not assuming homoscedasticity ")+
  scale_color_manual(values=Colors)+
  theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  theme(axis.text.x=element_text(angle=25,vjust=0.5))+
scale_x_discrete(limits=c("COREDNA", "Mastitis", "EZFood",  "Pfood", "PSoilP", "PviralDNA", "ZymoDNA"))

```

***
<style>
div.type0 { background-color:#BFBFBF; border-radius: 5px; padding: 20px;}
</style>
<div class = "type0">
<p style="color:black;font-size:15px;"> <b> 
Model not assuming homoscedasticity and including VariableKit + SpikeSet + qPCRefficiency was chosen.<br> qPCRefficiency is forced into all final models </b>

Formula: mod.Bacteria.all = nlme::gls(LogCopiespermLofMilk ~ VariableKit + SpikeSet + qPCRefficiency, data = TotalBacterialDNA.InnOnly.InnOnly,weights = varIdent(form = ~1 | VariableKit))<br>
<br>
<b> AIC(mod.Bacteria.all) # best model<br>
10.10053 <br> </b>
 <br>
<br>
Other Models for Reference: <br>
<br>
mod.Bacteria = nlme::gls(LogCopiespermLofMilk ~ VariableKit + SpikeSet, data=TotalBacterialDNA.InnOnly,
                 weights = varIdent(form = ~1 | VariableKit))<br>
AIC(mod.Bacteria)
 15.55897<br>
 <br>

 mod3.Bacteria = nlme::gls(LogCopiespermLofMilk ~ VariableKit, data=TotalBacterialDNA.InnOnly,
                 weights = varIdent(form = ~1 | VariableKit))<br>
AIC(mod3.Bacteria) <br> 
254.6237 <br>
<br>

Previously chosen Linear Model that assumed homoscedasticity for reference: <br>
m_TotalBacterialDNA.LogCopiespermLofMilk <- lm( LogCopiespermLofMilk ~ VariableKit + SpikeSet, data=TotalBacterialDNA.InnOnly ) <br>
AIC(m_TotalBacterialDNA.LogCopiespermLofMilk1) <br>
241.4133 <br>

</p>
</div>

***


***
<style>
div.type2 { background-color:#66C2A5; border-radius: 15px; padding: 20px;}
</style>
<div class = "type2">
<p style="color:black;font-size:20px;"> <b>Manuscript Figures: Total Bacteria </b></p>
</div>

***

```{r}
# Total Bacteria: Milk Data and Controls
Bacteria.Inn.Ctrl <- TotalBacterialDNA %>% filter(VariableSampleType!="NP40InoculatedMilk")
dim(Bacteria.Inn.Ctrl)

Colors <- c("COREDNA" = "#4DB3C7", "EZFood"= "#85CA46", "Mastitis"= "#F49D00","Pfood"= "#D2338B", "PSoilP"="#1D6E9B", "PviralDNA"= "#6850B4", "ZymoDNA"="#165F05")


Bacteria.Inn.Ctrl$VariableSampleType <- factor(Bacteria.Inn.Ctrl$VariableSampleType, levels=c('InoculatedMilk', 'UninoculatedMilk', 'NoTemplateControl', 'MockCommunity'))

ggplot(data=Bacteria.Inn.Ctrl, aes(VariableKit,LogCopiespermLofMilk, color= VariableKit, shape=SpikeSet))+
  scale_shape_discrete(solid=F) +
  ylab ("Bacteria Log10 Copies / mL of Milk")+  
  xlab ("Kit")+
  geom_point(aes(colour = VariableKit), size = 2, stroke = .5, position=position_jitterdodge(jitter.width=0, dodge.width = 1), show.legend = F) +
  facet_wrap(vars(VariableSampleType),nrow = 1)+
  ggtitle("Total Bacteria DNA Copy Numbers - All Samples and Controls")+
  theme_bw()+
  ylim(0, 9)+
  scale_color_manual(values=Colors)+
  theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  theme(axis.text.x=element_text(angle=90,vjust=0.5))+
  scale_x_discrete(limits=c("COREDNA", "Mastitis", "EZFood",  "Pfood", "PSoilP", "PviralDNA", "ZymoDNA"))

ggsave("Bacteria-AllSamples.TIFF", width = 9, height = 3,units = "in", dpi = 600)

ggplot(TotalBacterialDNA.InnOnly, aes(VariableKit,LogCopiespermLofMilk,shape = factor(SpikeSet))) +
  scale_shape_discrete(solid=F) +
  geom_point(aes(colour = VariableKit), size = 2, stroke = 1, position=position_jitterdodge(jitter.width=0, dodge.width = 1)) +
  ylab ("Log10 Copies / mL of Milk")+
  xlab ("Kit")+
  ggtitle("Total Bacteria DNA Copy Numbers - Inoculated Milk Only")+
  theme_bw()+
  scale_color_manual(values=Colors)+
  theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  theme(axis.text.x=element_text(angle=25,vjust=0.5))+
  scale_x_discrete(limits=c("COREDNA", "Mastitis", "EZFood",  "Pfood", "PSoilP", "PviralDNA", "ZymoDNA"))
```

```{r}
# Plot overlaying model estimates to raw data
mod_df1_Bacteria.rawdata<-TotalBacterialDNA.InnOnly[c(25,42,4)]

mod_df2_Bacteria.best.model<-emmeans(mod.Bacteria.best,~VariableKit, mode = "df.error") %>%
  summary() %>%
  data.frame()

ggplot() +
  geom_jitter(data=mod_df1_Bacteria.rawdata,aes(x=VariableKit,y=LogCopiespermLofMilk,color=VariableKit, shape=SpikeSet), size = 2,stroke = 1, width = .2 ) +
   scale_shape_discrete(solid=F) +
  scale_color_manual(values=Colors)+
  geom_errorbar(data=mod_df2_Bacteria.best.model,aes(x=VariableKit,ymin=lower.CL,ymax=upper.CL),width=0.3)+  
  geom_point(data=mod_df2_Bacteria.best.model,aes(x=VariableKit,y=emmean,fill=VariableKit))+
  geom_text(data =data.frame(mod.Bacteria.best_cld_letters),aes(x=VariableKit,label=`.group`, y=emmean), nudge_y = -3, nudge_x = -0.05, fontface = "bold") +
#ylim(3.5, 6.5)+
ylab ("Log10 Copies / mL of Milk")+
  xlab ("Kit")+
  ggtitle("Bacteria DNA Copy Numbers - Inoculated Milk Only")+
   theme_bw()+
   theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  scale_x_discrete(limits=c("COREDNA", "Mastitis", "EZFood",  "Pfood", "PSoilP", "PviralDNA", "ZymoDNA"))

ggsave("Bacteria-Model-Jitter.TIFF", width = 7.5, height = 3.5 , units = "in", dpi = 600)

ggplot() +
  geom_point(data=mod_df1_Bacteria.rawdata,aes(x=VariableKit,y=LogCopiespermLofMilk,color=VariableKit, shape=SpikeSet), size = 2, stroke = 1, position=position_jitterdodge(jitter.width=0, dodge.width = .5)) +
   scale_shape_discrete(solid=F) +
  scale_color_manual(values=Colors)+
  geom_errorbar(data=mod_df2_Bacteria.best.model,aes(x=VariableKit,ymin=lower.CL,ymax=upper.CL),width=0.3)+  
  geom_point(data=mod_df2_Bacteria.best.model,aes(x=VariableKit,y=emmean,fill=VariableKit))+
  geom_text(data =data.frame(mod.Bacteria.best_cld_letters),aes(x=VariableKit,label=`.group`, y=emmean), nudge_y = -2, nudge_x = -0.05, fontface = "bold") +
#ylim(3.5, 6.5)+
ylab ("Log10 Copies / mL of Milk")+
  xlab ("Kit")+
  ggtitle("Bacteria DNA Copy Numbers - Inoculated Milk Only")+
   theme_bw()+
   theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  scale_x_discrete(limits=c("COREDNA", "Mastitis", "EZFood",  "Pfood", "PSoilP", "PviralDNA", "ZymoDNA"))
ggsave("Bacteria-Model.TIFF", width = 7.5, height = 3.5 , units = "in", dpi = 600)
```


***
<style>
div.type1 { background-color:#000000; border-radius: 5px; padding: 20px;}
</style>
<div class = "type1">
<p style="color:white;font-size:60px;"> <b> <i>Bacillus </i> </b></p>
</div>

***

# Bacillus wiedmannii Copy Numbers
```{r}
#Data File: CleanDNAprepData1.18.19
library(ggplot2)
library(dplyr)
library(emmeans)
library(multcompView)

#Filter Subset from Sample Data
Bacillus <- SampleData %>% filter(Assay=="Bacillus wiedmannii")
dim(Bacillus)

#Summary Statistics

Bacillus.summary <- Bacillus %>%
  group_by(VariableKit,VariableSampleType) %>%
  summarize(mean_LogCopiespermLofMilk=mean(LogCopiespermLofMilk,na.rm=T),
            st_dev=sd(LogCopiespermLofMilk,na.rm=T),
            n_missing=sum(is.na(LogCopiespermLofMilk)),
            n_total=n())%>%
  data.frame()
  
write.table (Bacillus.summary, "Bacillus.summary.txt", sep="\t" )
```

```{r}
#Plot Raw Means and Standard Deviations
Colors <- c("COREDNA" = "#4DB3C7", "EZFood"= "#85CA46", "Mastitis"= "#F49D00","Pfood"= "#D2326B", "PSoilP"="#1D6E9B", "PviralDNA"= "#6850B4", "ZymoDNA"="#165F05")
ggplot(data=Bacillus,
       mapping=aes(x=VariableSampleType,y=LogCopiespermLofMilk,z=VariableKit, color=VariableKit, ylab="Copy Numbers")) +
  ylab ("Log10 Copies / mL of Milk")+
  geom_boxplot(lwd=1)+
  theme_bw()+
  ggtitle("Bacillus Copy Numbers")+
  scale_color_manual(values=Colors)+
  theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  theme(axis.text.x=element_text(angle=25,vjust=0.5))+
  scale_x_discrete(limits=c("UninoculatedMilk", "InoculatedMilk", "NP40InoculatedMilk",  "MockCommunity", "NoTemplateControl"))






ggplot(data=Bacillus,
       mapping=aes(x=VariableSampleType,y=LogCopiespermLofMilk, color=VariableKit, shape=SpikeSet)) +
  ylab ("Log10 Copies / mL of Milk")+
      geom_jitter(width=0.25)+
  ggtitle("Bacillus Copy Numbers")+
  theme_bw()+
  scale_color_manual(values=Colors)+
  theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  theme(axis.text.x=element_text(angle=25,vjust=0.5))+
  scale_x_discrete(limits=c("UninoculatedMilk", "InoculatedMilk", "NP40InoculatedMilk",  "MockCommunity", "NoTemplateControl"))


ggplot(data=Bacillus,
       mapping=aes(x=VariableSampleType,y=LogCopiespermLofMilk, color=SpikeSet, shape=VariableKit)) +
  ylab ("Log10 Copies / mL of Milk")+
    geom_jitter(width=0.35)+
  ggtitle("Bacillus Copy Numbers")+
  theme_bw()+
  theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  theme(axis.text.x=element_text(angle=25,vjust=0.5))+
  scale_x_discrete(limits=c("UninoculatedMilk", "InoculatedMilk", "NP40InoculatedMilk",  "MockCommunity", "NoTemplateControl"))

```

```{r}
# Inoculated Milk Data
Bacillus.InnOnly <- Bacillus %>% filter(VariableSampleType=="InoculatedMilk", LogCopiespermLofMilk>0.001)
Bacillus.InnOnly %>%
  group_by(VariableSampleType, VariableSpikeSet, VariableKit) %>%
  summarize(mean_LogCopiespermLofMilk=mean(LogCopiespermLofMilk,na.rm=T),
            st_dev=sd(LogCopiespermLofMilk,na.rm=T),
            n_missing=sum(is.na(LogCopiespermLofMilk)),
            n_total=n())%>%
  data.frame()
```
## Model Selection
### Linear Models
```{r}
#3 linear models were compared: including SpikeSet only, qPCRefficiency only, and both as covariates. Best model fit was used as the final model. 

m_Bacillus.LogCopiespermLofMilk1 <- lm( LogCopiespermLofMilk ~ VariableKit + SpikeSet, data=Bacillus.InnOnly )
summary(m_Bacillus.LogCopiespermLofMilk1)

m_Bacillus.LogCopiespermLofMilk2 <- lm( LogCopiespermLofMilk ~ VariableKit + qPCRefficiency, data=Bacillus.InnOnly )
summary(m_Bacillus.LogCopiespermLofMilk2)

m_Bacillus.LogCopiespermLofMilk3 <- lm( LogCopiespermLofMilk ~ VariableKit + qPCRefficiency + SpikeSet, data=Bacillus.InnOnly )
summary(m_Bacillus.LogCopiespermLofMilk3)


# Fit of model with both qPCRefficiency and SpikeSet is slightly better than fit of model with SpikeSet only
anova(m_Bacillus.LogCopiespermLofMilk1, m_Bacillus.LogCopiespermLofMilk2, m_Bacillus.LogCopiespermLofMilk3)

AIC(m_Bacillus.LogCopiespermLofMilk1)
AIC(m_Bacillus.LogCopiespermLofMilk2)
AIC(m_Bacillus.LogCopiespermLofMilk3)

# Final model chosen:
# Model 3:  LogCopiespermLofMilk ~ VariableKit + qPCRefficiency + SpikeSet
```
### Mixed effects models - for reference
```{r}
library(lme4)
library(lmerTest)

model1 = lmer(LogCopiespermLofMilk ~ VariableKit + (1|SpikeSet),
            data=Bacillus.InnOnly,
            REML=TRUE)
summary(model1)

model2 = lmer(LogCopiespermLofMilk ~ VariableKit + qPCRefficiency + (1|SpikeSet),
            data=Bacillus.InnOnly,
            REML=TRUE)
summary(model2)

anova(model1, model2)
AIC (model1)
AIC (model2)
AIC(m_Bacillus.LogCopiespermLofMilk3) #still has better fit
```

## Final Model
```{r}
m_Bacillus.LogCopiespermLofMilk <- lm( LogCopiespermLofMilk ~ VariableKit + qPCRefficiency + SpikeSet, data=Bacillus.InnOnly )
summary(m_Bacillus.LogCopiespermLofMilk)


plot(x=predict(m_Bacillus.LogCopiespermLofMilk),y=resid(m_Bacillus.LogCopiespermLofMilk))

  # using ggplot2
Colors <- c("COREDNA" = "#4DB3C7", "EZFood"= "#85CA46", "Mastitis"= "#F49D00","Pfood"= "#D2326B", "PSoilP"="#1D6E9B", "PviralDNA"= "#6850B4", "ZymoDNA"="#165F05")
 
ggplot(m_Bacillus.LogCopiespermLofMilk, aes(x=predict(m_Bacillus.LogCopiespermLofMilk), y=resid(m_Bacillus.LogCopiespermLofMilk), color=VariableKit)) +
  geom_point()+
  theme_bw()+
  ggtitle("Bacillus Innoculated Only - Model Fit - Residuals vs Predicted")+
  scale_color_manual(values=Colors)+
  theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  geom_hline(yintercept = 1) +
  geom_hline(yintercept = -1)

  # qqplots
qqnorm(resid(m_Bacillus.LogCopiespermLofMilk))
qqline(resid(m_Bacillus.LogCopiespermLofMilk))
summary(m_Bacillus.LogCopiespermLofMilk)

#Few large residuals were identified, most belong to EZFood

Bacillus.InnOnly$resid <- resid(m_Bacillus.LogCopiespermLofMilk)
Bacillus.InnOnly %>% 
  filter(abs(resid)>1) %>%
  select(VariableKit,resid) %>%
  group_by(VariableKit) %>%
  summarize(n=n())

```

```{r}
# Check Tukey-adjusted pairwise comparison of kit estimates
m_Bacillus.LogCopiespermLofMilk_emmeans <- emmeans(m_Bacillus.LogCopiespermLofMilk,pairwise~VariableKit)
# Use compact letter display for convenience
m_Bacillus.LogCopiespermLofMilk_cld <- CLD(m_Bacillus.LogCopiespermLofMilk_emmeans$emmeans,
                                         Letters=LETTERS)
m_Bacillus.LogCopiespermLofMilk_cld

# Get fitted values from model to plot with other software
emmeans(m_Bacillus.LogCopiespermLofMilk,~ VariableKit) %>%
  summary() %>%
  data.frame() 

# Plot fitted values from model
Colors <- c("COREDNA" = "#4DB3C7", "EZFood"= "#85CA46", "Mastitis"= "#F49D00","Pfood"= "#D2326B", "PSoilP"="#1D6E9B", "PviralDNA"= "#6850B4", "ZymoDNA"="#165F05")
emmeans(m_Bacillus.LogCopiespermLofMilk,~VariableKit) %>%
  summary() %>%
  data.frame() %>%
  ggplot(aes(x=VariableKit,y=emmean,color=VariableKit)) +
  geom_point() +
  labs(y="Estimated Marginal Means") +
  geom_errorbar(aes(ymin=lower.CL,ymax=upper.CL),width=0.5) +
  geom_text(data=data.frame(m_Bacillus.LogCopiespermLofMilk_cld),aes(x=VariableKit,label=`.group`),hjust=-.1) +
  theme_bw()+
  ggtitle("Bacillus Copy Numbers - Inoculated Milk Only")+
  scale_color_manual(values=Colors)+
  theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  theme(axis.text.x=element_text(angle=25,vjust=0.5))+
  scale_x_discrete(limits=c("COREDNA", "Mastitis", "EZFood",  "Pfood", "PSoilP", "PviralDNA", "ZymoDNA"))

```



## Bacillus - Models not assuming homoscedasticity

```{r}
# from https://cran.r-project.org/web/packages/emmeans/vignettes/FAQs.html#contents

library(nlme)
# Final model chosen:
# Model 3:  LogCopiespermLofMilk ~ VariableKit + qPCRefficiency + SpikeSet
# m_Bacillus.LogCopiespermLofMilk3 <- lm( LogCopiespermLofMilk ~ VariableKit + qPCRefficiency + SpikeSet, data=Bacillus.InnOnly )

mod.Bacillus = nlme::gls(LogCopiespermLofMilk ~ VariableKit + qPCRefficiency + SpikeSet, data=Bacillus.InnOnly,
                 weights = varIdent(form = ~1 | VariableKit))
summary(mod.Bacillus)

AIC(m_Bacillus.LogCopiespermLofMilk3)
AIC(mod.Bacillus)

# Testing simpler model

mod3.Bacillus = nlme::gls(LogCopiespermLofMilk ~ VariableKit, data=Bacillus.InnOnly,
                 weights = varIdent(form = ~1 | VariableKit))
summary(mod3.Bacillus)

AIC(m_Bacillus.LogCopiespermLofMilk3)
AIC(mod.Bacillus)
AIC(mod3.Bacillus) #mod.Bacillus is best model (including qPCRefficiency and SpikeSet)

#mod.Bacillus not assuming homoscedasticity and including qPCRefficiency and SpikeSet has better fit 

mod.Bacillus.best <- mod.Bacillus
```

### Final Bacillus Figure
```{r}

# Check Tukey-adjusted pairwise comparison of kit estimates
mod.Bacillus_emmeans <- emmeans(mod.Bacillus,pairwise~VariableKit)
# Use compact letter display for convenience
mod.Bacillus_cld <- CLD(mod.Bacillus_emmeans$emmeans, sort=TRUE, details=TRUE, Letters=LETTERS)
mod.Bacillus_cld_letters <- CLD(mod.Bacillus_emmeans$emmeans, Letters=LETTERS)
mod.Bacillus_cld

# Get fitted values from model to plot with other software
emmeans(mod.Bacillus,~ VariableKit) %>%
  summary() %>%
  data.frame() 

# Get summary
summary(emmeans(mod.Bacillus,~ VariableKit), infer=TRUE)

# Plot overlaying model estimates to raw data
mod.Bacillus_df1_Bacillus.rawdata<-Bacillus.InnOnly[c(25,42,4)]

mod.Bacillus_df2_Bacillus.model<-emmeans(mod.Bacillus,~VariableKit) %>%
  summary() %>%
  data.frame()

ggplot() +
  geom_jitter(data=mod.Bacillus_df1_Bacillus.rawdata,aes(x=VariableKit,y=LogCopiespermLofMilk)) +
  geom_point(data=mod.Bacillus_df2_Bacillus.model,aes(x=VariableKit,y=emmean,fill=VariableKit))+
  geom_errorbar(data=mod.Bacillus_df2_Bacillus.model,aes(x=VariableKit,ymin=lower.CL,ymax=upper.CL),width=0.5)

# Making the plot pretty

Colors <- c("COREDNA" = "#4DB3C7", "EZFood"= "#85CA46", "Mastitis"= "#F49D00","Pfood"= "#D2326B", "PSoilP"="#1D6E9B", "PviralDNA"= "#6850B4", "ZymoDNA"="#165F05")


ggplot() +
  geom_jitter(data=mod.Bacillus_df1_Bacillus.rawdata,aes(x=VariableKit,y=LogCopiespermLofMilk, color=VariableKit, shape=SpikeSet)) +
  scale_color_manual(values=Colors)+
   geom_errorbar(data=mod.Bacillus_df2_Bacillus.model,aes(x=VariableKit,ymin=lower.CL,ymax=upper.CL),width=0.5)+
   geom_point(data=mod.Bacillus_df2_Bacillus.model,aes(x=VariableKit,y=emmean,fill=VariableKit))+
  geom_text(data =data.frame(mod.Bacillus_cld_letters),aes(x=VariableKit,label=`.group`, y=emmean), nudge_y = 0.2, nudge_x = -0.05, fontface = "bold")+
ylim(3.0, 8.0)+
xlab("Kit")+
ylab ("Log10 Copies / mL of Milk")+
  theme_bw()+
  ggtitle("Bacillus Copy Numbers - Inoculated Milk Only - Not assuming homoscedasticity ")+
  scale_color_manual(values=Colors)+
  theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  theme(axis.text.x=element_text(angle=25,vjust=0.5))+
scale_x_discrete(limits=c("COREDNA", "Mastitis", "EZFood",  "Pfood", "PSoilP", "PviralDNA", "ZymoDNA"))
```

### Bacillus Figure
```{r}
library(emmeans)
# Check Tukey-adjusted pairwise comparison of kit estimates
mod.Bacillus.best_emmeans <- emmeans(mod.Bacillus.best,pairwise~VariableKit, mode = "df.error")

# Use compact letter display for convenience
mod.Bacillus.best_cld <- CLD(mod.Bacillus.best_emmeans$emmeans, sort=TRUE, details=TRUE, Letters=LETTERS)
mod.Bacillus.best_cld_letters <- CLD(mod.Bacillus.best_emmeans$emmeans, Letters=LETTERS)
mod.Bacillus.best_cld_letters

# Get fitted values from model to plot with other software
emmeans(mod.Bacillus.best,~ VariableKit,mode = "df.error") %>%
  summary() %>%
  data.frame() 

# Get summary
summary(emmeans(mod.Bacillus.best,~ VariableKit,mode = "df.error"), infer=TRUE)

# Plot overlaying model estimates to raw data
mod_df1_Bacillus.rawdata<-Bacillus.InnOnly[c(25,42,4)]

mod_df2_Bacillus.best.model<-emmeans(mod.Bacillus.best,~VariableKit, mode = "df.error") %>%
  summary() %>%
  data.frame()

ggplot() +
  geom_jitter(data=mod_df1_Bacillus.rawdata,aes(x=VariableKit,y=LogCopiespermLofMilk)) +
  geom_point(data=mod_df2_Bacillus.best.model,aes(x=VariableKit,y=emmean,fill=VariableKit))+
  geom_errorbar(data=mod_df2_Bacillus.best.model,aes(x=VariableKit,ymin=lower.CL,ymax=upper.CL),width=0.5)

# Making the plot pretty

Colors <- c("COREDNA" = "#4DB3C7", "EZFood"= "#85CA46", "Mastitis"= "#F49D00","Pfood"= "#D2326B", "PSoilP"="#1D6E9B", "PviralDNA"= "#6850B4", "ZymoDNA"="#165F05")
  
ggplot() +
  geom_jitter(data=mod_df1_Bacillus.rawdata,aes(x=VariableKit,y=LogCopiespermLofMilk,color=VariableKit, shape=SpikeSet)) +
  scale_color_manual(values=Colors)+
  geom_errorbar(data=mod_df2_Bacillus.best.model,aes(x=VariableKit,ymin=lower.CL,ymax=upper.CL),width=0.3)+  
  geom_point(data=mod_df2_Bacillus.best.model,aes(x=VariableKit,y=emmean,fill=VariableKit))+
  geom_text(data =data.frame(mod.Bacillus.best_cld_letters),aes(x=VariableKit,label=`.group`, y=emmean), nudge_y = 0.2, nudge_x = -0.05, fontface = "bold") +
#ylim(3.5, 6.5)+
xlab("Kit")+
ylab ("Log10 Copies / mL of Milk")+
  theme_bw()+
  ggtitle("Bacillus Copy Numbers - Inoculated Milk Only - Not assuming homoscedasticity ")+
  scale_color_manual(values=Colors)+
  theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  theme(axis.text.x=element_text(angle=25,vjust=0.5))+
scale_x_discrete(limits=c("COREDNA", "Mastitis", "EZFood",  "Pfood", "PSoilP", "PviralDNA", "ZymoDNA"))

```
***
<style>
div.type0 { background-color:#BFBFBF; border-radius: 5px; padding: 20px;}
</style>
<div class = "type0">
<p style="color:black;font-size:15px;"> <b> 
Model not assuming homoscedasticity and including VariableKit + SpikeSet + qPCRefficiency was chosen.<br> qPCRefficiency is forced into all final models </b>

Formula:mod.Bacillus = nlme::gls(LogCopiespermLofMilk ~ VariableKit + qPCRefficiency + SpikeSet, data=Bacillus.InnOnly,
                 weights = varIdent(form = ~1 | VariableKit))<br>
<br>
<b> AIC(mod.Bacillus) <br>
-48.92209<br> </b>
 <br>
<br>
Other Models for Reference: <br>
<br>
Formula: mod3.Bacillus = nlme::gls(LogCopiespermLofMilk ~ VariableKit, data=Bacillus.InnOnly,
                 weights = varIdent(form = ~1 | VariableKit)) <br>
AIC(mod3.Bacillus) <br>
167.8347 <br>

Previously chosen Linear Model that assumed homoscedasticity for reference: <br>
Formula: m_Bacillus.LogCopiespermLofMilk3 <- lm( LogCopiespermLofMilk ~ VariableKit + qPCRefficiency + SpikeSet, data=Bacillus.InnOnly ) <br>
AIC(m_Bacillus.LogCopiespermLofMilk3)<br>
71.91107<br>

</p>
</div>

***


***
<style>
div.type2 { background-color:#66C2A5; border-radius: 15px; padding: 20px;}
</style>
<div class = "type2">
<p style="color:black;font-size:20px;"> <b>Manuscript Figures: Bacillus </b></p>
</div>

***

```{r}
# Bacillus: Milk Data and Controls
Bacillus.Inn.Ctrl <- Bacillus %>% filter(VariableSampleType!="NP40InoculatedMilk")
dim(Bacillus.Inn.Ctrl)

Colors <- c("COREDNA" = "#4DB3C7", "EZFood"= "#85CA46", "Mastitis"= "#F49D00","Pfood"= "#D2338B", "PSoilP"="#1D6E9B", "PviralDNA"= "#6850B4", "ZymoDNA"="#165F05")


Bacillus.Inn.Ctrl$VariableSampleType <- factor(Bacillus.Inn.Ctrl$VariableSampleType, levels=c('InoculatedMilk', 'UninoculatedMilk', 'NoTemplateControl', 'MockCommunity'))

ggplot(data=Bacillus.Inn.Ctrl, aes(VariableKit,LogCopiespermLofMilk, color= VariableKit, shape=SpikeSet))+
  scale_shape_discrete(solid=F) +
  ylab ("Bacillus Log10 Copies / mL of Milk")+  
  xlab ("Kit")+
  geom_point(aes(colour = VariableKit), size = 2, stroke = .5, position=position_jitterdodge(jitter.width=0, dodge.width = 1), show.legend = F) +
  facet_wrap(vars(VariableSampleType),nrow = 1)+
  ggtitle("Bacillus DNA Copy Numbers - All Samples and Controls")+
  theme_bw()+
  ylim(0, 9)+
  scale_color_manual(values=Colors)+
  theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  theme(axis.text.x=element_text(angle=90,vjust=0.5))+
  scale_x_discrete(limits=c("COREDNA", "Mastitis", "EZFood",  "Pfood", "PSoilP", "PviralDNA", "ZymoDNA"))

ggsave("Bacillus-AllSamples.TIFF", width = 9, height = 3,units = "in", dpi = 600)

ggplot(Bacillus.InnOnly, aes(VariableKit,LogCopiespermLofMilk,shape = factor(SpikeSet))) +
  scale_shape_discrete(solid=F) +
  geom_point(aes(colour = VariableKit), size = 2, stroke = 1, position=position_jitterdodge(jitter.width=0, dodge.width = 1)) +
  ylab ("Log10 Copies / mL of Milk")+
  xlab ("Kit")+
  ggtitle("Bacillus DNA Copy Numbers - Inoculated Milk Only")+
  theme_bw()+
  scale_color_manual(values=Colors)+
  theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  theme(axis.text.x=element_text(angle=25,vjust=0.5))+
  scale_x_discrete(limits=c("COREDNA", "Mastitis", "EZFood",  "Pfood", "PSoilP", "PviralDNA", "ZymoDNA"))
```

```{r}
# Plot overlaying model estimates to raw data
mod_df1_Bacillus.rawdata<- Bacillus.InnOnly[c(25,42,4)]

mod_df2_Bacillus.best.model<-emmeans(mod3,~VariableKit, mode = "df.error") %>%
  summary() %>%
  data.frame()

ggplot() +
  geom_jitter(data=mod_df1_Bacillus.rawdata,aes(x=VariableKit,y=LogCopiespermLofMilk,color=VariableKit, shape=SpikeSet), size = 2,stroke = 1, width = .2 ) +
   scale_shape_discrete(solid=F) +
  scale_color_manual(values=Colors)+
  geom_errorbar(data=mod_df2_Bacillus.best.model,aes(x=VariableKit,ymin=lower.CL,ymax=upper.CL),width=0.3)+  
  geom_point(data=mod_df2_Bacillus.best.model,aes(x=VariableKit,y=emmean,fill=VariableKit))+
  geom_text(data =data.frame(mod.Bacillus.best_cld_letters),aes(x=VariableKit,label=`.group`, y=emmean), nudge_y = -2, nudge_x = -0.05, fontface = "bold") +
#ylim(3.5, 6.5)+
ylab ("Log10 Copies / mL of Milk")+
  xlab ("Kit")+
  ggtitle("Bacillus DNA Copy Numbers - Inoculated Milk Only")+
   theme_bw()+
   theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  scale_x_discrete(limits=c("COREDNA", "Mastitis", "EZFood",  "Pfood", "PSoilP", "PviralDNA", "ZymoDNA"))

ggsave("Bacillus-Model-Jitter.TIFF", width = 7.5, height = 3.5 , units = "in", dpi = 600)


ggplot() +
  geom_point(data=mod_df1_Bacillus.rawdata,aes(x=VariableKit,y=LogCopiespermLofMilk,color=VariableKit, shape=SpikeSet), size = 2, stroke = 1, position=position_jitterdodge(jitter.width=0, dodge.width = .5)) +
   scale_shape_discrete(solid=F) +
  scale_color_manual(values=Colors)+
  geom_errorbar(data=mod_df2_Bacillus.best.model,aes(x=VariableKit,ymin=lower.CL,ymax=upper.CL),width=0.3)+  
  geom_point(data=mod_df2_Bacillus.best.model,aes(x=VariableKit,y=emmean,fill=VariableKit))+
  geom_text(data =data.frame(mod.Bacillus.best_cld_letters),aes(x=VariableKit,label=`.group`, y=emmean), nudge_y = -2, nudge_x = -0.05, fontface = "bold") +
#ylim(3.5, 6.5)+
ylab ("Log10 Copies / mL of Milk")+
  xlab ("Kit")+
  ggtitle("Bacillus DNA Copy Numbers - Inoculated Milk Only")+
   theme_bw()+
   theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  scale_x_discrete(limits=c("COREDNA", "Mastitis", "EZFood",  "Pfood", "PSoilP", "PviralDNA", "ZymoDNA"))
ggsave("Bacillus-Model.TIFF", width = 7.5, height = 3.5 , units = "in", dpi = 600)
```



***
<style>
div.type1 { background-color:#000000; border-radius: 5px; padding: 20px;}
</style>
<div class = "type1">
<p style="color:white;font-size:60px;"> <b> <i>Listeria </i> </b></p>
</div>

***

# Listeria monocytogenes Copy Numbers
```{r}
#Data File: CleanDNAprepData1.18.19
library(ggplot2)
library(dplyr)
library(emmeans)
library(multcompView)

#Filter Subset from Sample Data
Listeria <- SampleData %>% filter(Assay=="Listeria monocytogenes")
dim(Listeria)

#Summary Statistics

Listeria.summary <- Listeria %>%
 group_by(VariableKit,VariableSampleType) %>%
  summarize(mean_LogCopiespermLofMilk=mean(LogCopiespermLofMilk,na.rm=T),
            st_dev=sd(LogCopiespermLofMilk,na.rm=T),
            n_missing=sum(is.na(LogCopiespermLofMilk)),
            n_total=n())%>%
  data.frame()
  
write.table (Listeria.summary, "Listeria.summary.txt", sep="\t" )
```

```{r}
#Plot Raw Means and Standard Deviations
Colors <- c("COREDNA" = "#4DB3C7", "EZFood"= "#85CA46", "Mastitis"= "#F49D00","Pfood"= "#D2326B", "PSoilP"="#1D6E9B", "PviralDNA"= "#6850B4", "ZymoDNA"="#165F05")
ggplot(data=Listeria,
       mapping=aes(x=VariableSampleType,y=LogCopiespermLofMilk,z=VariableKit, color=VariableKit, ylab="Copy Numbers")) +
  ylab ("Log10 Copies / mL of Milk")+
  geom_boxplot(lwd=1)+
  theme_bw()+
  ggtitle("Listeria Copy Numbers")+
  scale_color_manual(values=Colors)+
  theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  theme(axis.text.x=element_text(angle=25,vjust=0.5))+
  scale_x_discrete(limits=c("UninoculatedMilk", "InoculatedMilk", "NP40InoculatedMilk",  "MockCommunity", "NoTemplateControl"))



ggplot(data=Listeria,
       mapping=aes(x=VariableSampleType,y=LogCopiespermLofMilk, color=VariableKit, shape=SpikeSet)) +
  ylab ("Log10 Copies / mL of Milk")+
      geom_jitter(width=0.25)+
  ggtitle("Listeria Copy Numbers")+
  theme_bw()+
  scale_color_manual(values=Colors)+
  theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  theme(axis.text.x=element_text(angle=25,vjust=0.5))+
  scale_x_discrete(limits=c("UninoculatedMilk", "InoculatedMilk", "NP40InoculatedMilk",  "MockCommunity", "NoTemplateControl"))



ggplot(data=Listeria,
       mapping=aes(x=VariableSampleType,y=LogCopiespermLofMilk, color=SpikeSet, shape=VariableKit)) +
  ylab ("Log10 Copies / mL of Milk")+
    geom_jitter(width=0.35)+
  ggtitle("Listeria Copy Numbers")+
  theme_bw()+
  theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  theme(axis.text.x=element_text(angle=25,vjust=0.5))+
  scale_x_discrete(limits=c("UninoculatedMilk", "InoculatedMilk", "NP40InoculatedMilk",  "MockCommunity", "NoTemplateControl"))

```

```{r}
# Inoculated Milk Data
Listeria.InnOnly <- Listeria %>% filter(VariableSampleType=="InoculatedMilk", LogCopiespermLofMilk>0.001)
Listeria.InnOnly %>%
  group_by(VariableSampleType, VariableSpikeSet, VariableKit) %>%
  summarize(mean_LogCopiespermLofMilk=mean(LogCopiespermLofMilk,na.rm=T),
            st_dev=sd(LogCopiespermLofMilk,na.rm=T),
            n_missing=sum(is.na(LogCopiespermLofMilk)),
            n_total=n())%>%
  data.frame()
```
## Model Selection
### Linear Models
```{r}
#3 linear models were compared: including SpikeSet only, qPCRefficiency only, and both as covariates. Best model fit was used as the final model. 
m_Listeria.LogCopiespermLofMilk1 <- lm( LogCopiespermLofMilk ~ VariableKit + SpikeSet, data=Listeria.InnOnly )
summary(m_Listeria.LogCopiespermLofMilk1)

m_Listeria.LogCopiespermLofMilk2 <- lm( LogCopiespermLofMilk ~ VariableKit + qPCRefficiency, data=Listeria.InnOnly )
summary(m_Listeria.LogCopiespermLofMilk2)

m_Listeria.LogCopiespermLofMilk3 <- lm( LogCopiespermLofMilk ~ VariableKit + qPCRefficiency + SpikeSet, data=Listeria.InnOnly )
summary(m_Listeria.LogCopiespermLofMilk3)

# Fit of model with both qPCRefficiency and SpikeSet is better than fit of model with SpikeSet only
anova(m_Listeria.LogCopiespermLofMilk1, m_Listeria.LogCopiespermLofMilk2, m_Listeria.LogCopiespermLofMilk3)

AIC(m_Listeria.LogCopiespermLofMilk1)
AIC(m_Listeria.LogCopiespermLofMilk2)
AIC(m_Listeria.LogCopiespermLofMilk3)
# Final model chosen:
# Model 3:  LogCopiespermLofMilk ~ VariableKit + qPCRefficiency + SpikeSet
# m_Listeria.LogCopiespermLofMilk3 <- lm( LogCopiespermLofMilk ~ VariableKit + qPCRefficiency + SpikeSet, data=Listeria.InnOnly )
```
### Mixed effects models - for reference
```{r}
library(lme4)
library(lmerTest)

model1 = lmer(LogCopiespermLofMilk ~ VariableKit + (1|SpikeSet),
            data=Listeria.InnOnly,
            REML=TRUE)
summary(model1)

model2 = lmer(LogCopiespermLofMilk ~ VariableKit + qPCRefficiency + (1|SpikeSet),
            data=Listeria.InnOnly,
            REML=TRUE)
summary(model2)

anova(model1, model2)
AIC (model1)
AIC (model2)
```

## Final Model
```{r}
m_Listeria.LogCopiespermLofMilk <- lm( LogCopiespermLofMilk ~ VariableKit + qPCRefficiency + SpikeSet, data=Listeria.InnOnly )
summary(m_Listeria.LogCopiespermLofMilk)


plot(x=predict(m_Listeria.LogCopiespermLofMilk),y=resid(m_Listeria.LogCopiespermLofMilk))

  # using ggplot2
Colors <- c("COREDNA" = "#4DB3C7", "EZFood"= "#85CA46", "Mastitis"= "#F49D00","Pfood"= "#D2326B", "PSoilP"="#1D6E9B", "PviralDNA"= "#6850B4", "ZymoDNA"="#165F05")
 
ggplot(m_Listeria.LogCopiespermLofMilk, aes(x=predict(m_Listeria.LogCopiespermLofMilk), y=resid(m_Listeria.LogCopiespermLofMilk), color=VariableKit)) +
  geom_point()+
  theme_bw()+
  ggtitle("Listeria Innoculated Only - Model Fit - Residuals vs Predicted")+
  scale_color_manual(values=Colors)+
  theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  geom_hline(yintercept = 1) +
  geom_hline(yintercept = -1)

  # qqplots
qqnorm(resid(m_Listeria.LogCopiespermLofMilk))
qqline(resid(m_Listeria.LogCopiespermLofMilk))
summary(m_Listeria.LogCopiespermLofMilk)

#No large residuals were identified

Listeria.InnOnly$resid <- resid(m_Listeria.LogCopiespermLofMilk)
Listeria.InnOnly %>% 
  filter(abs(resid)>1) %>%
  select(VariableKit,resid) %>%
  group_by(VariableKit) %>%
  summarize(n=n())

```

```{r}
# Check Tukey-adjusted pairwise comparison of kit estimates
m_Listeria.LogCopiespermLofMilk_emmeans <- emmeans(m_Listeria.LogCopiespermLofMilk,pairwise~VariableKit)
# Use compact letter display for convenience
m_Listeria.LogCopiespermLofMilk_cld <- CLD(m_Listeria.LogCopiespermLofMilk_emmeans$emmeans,
                                         Letters=LETTERS)
m_Listeria.LogCopiespermLofMilk_cld

# Get fitted values from model to plot with other software
emmeans(m_Listeria.LogCopiespermLofMilk,~ VariableKit) %>%
  summary() %>%
  data.frame() 

# Plot fitted values from model
Colors <- c("COREDNA" = "#4DB3C7", "EZFood"= "#85CA46", "Mastitis"= "#F49D00","Pfood"= "#D2326B", "PSoilP"="#1D6E9B", "PviralDNA"= "#6850B4", "ZymoDNA"="#165F05")
emmeans(m_Listeria.LogCopiespermLofMilk,~VariableKit) %>%
  summary() %>%
  data.frame() %>%
  ggplot(aes(x=VariableKit,y=emmean,color=VariableKit)) +
  geom_point() +
  labs(y="Estimated Marginal Means") +
  geom_errorbar(aes(ymin=lower.CL,ymax=upper.CL),width=0.5) +
  geom_text(data=data.frame(m_Listeria.LogCopiespermLofMilk_cld),aes(x=VariableKit,label=`.group`),hjust=-.1) +
  theme_bw()+
  ggtitle("Listeria Copy Numbers - Inoculated Milk Only")+
  scale_color_manual(values=Colors)+
  theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  theme(axis.text.x=element_text(angle=25,vjust=0.5))+
  scale_x_discrete(limits=c("COREDNA", "Mastitis", "EZFood",  "Pfood", "PSoilP", "PviralDNA", "ZymoDNA"))


```
## Listeria - Models not assuming homoscedasticity

```{r}
# from https://cran.r-project.org/web/packages/emmeans/vignettes/FAQs.html#contents

library(nlme)
# Final model chosen:
# Model 3:  LogCopiespermLofMilk ~ VariableKit + qPCRefficiency + SpikeSet
# m_Listeria.LogCopiespermLofMilk3 <- lm( LogCopiespermLofMilk ~ VariableKit + qPCRefficiency + SpikeSet, data=Listeria.InnOnly )

mod.Listeria = nlme::gls(LogCopiespermLofMilk ~ VariableKit + qPCRefficiency + SpikeSet, data=Listeria.InnOnly,
                 weights = varIdent(form = ~1 | VariableKit))
summary(mod.Listeria)

AIC(m_Listeria.LogCopiespermLofMilk3)
AIC(mod.Listeria)

# Testing simpler model

mod3.Listeria = nlme::gls(LogCopiespermLofMilk ~ VariableKit, data=Listeria.InnOnly,
                 weights = varIdent(form = ~1 | VariableKit))
summary(mod3.Listeria)

AIC(m_Listeria.LogCopiespermLofMilk3)
AIC(mod.Listeria)
AIC(mod3.Listeria) #mod.Listeria is best model (including qPCRefficiency and SpikeSet)
mod.Listeria.best <- mod.Listeria
#mod.Listeria not assuming homoscedasticity and including qPCRefficiency and SpikeSet is a much better fit than any of the alternatives

```


### Listeria Figure
```{r}
library(emmeans)
# Check Tukey-adjusted pairwise comparison of kit estimates
mod.Listeria.best_emmeans <- emmeans(mod.Listeria.best,pairwise~VariableKit, mode = "df.error")

# Use compact letter display for convenience
mod.Listeria.best_cld <- CLD(mod.Listeria.best_emmeans$emmeans, sort=TRUE, details=TRUE, Letters=LETTERS)
mod.Listeria.best_cld_letters <- CLD(mod.Listeria.best_emmeans$emmeans, Letters=LETTERS)
mod.Listeria.best_cld_letters

# Get fitted values from model to plot with other software
emmeans(mod.Listeria.best,~ VariableKit,mode = "df.error") %>%
  summary() %>%
  data.frame() 

# Get summary
summary(emmeans(mod.Listeria.best,~ VariableKit,mode = "df.error"), infer=TRUE)

# Plot overlaying model estimates to raw data
mod_df1_Listeria.rawdata<-Listeria.InnOnly[c(25,42,4)]

mod_df2_Listeria.best.model<-emmeans(mod.Listeria.best,~VariableKit, mode = "df.error") %>%
  summary() %>%
  data.frame()

ggplot() +
  geom_jitter(data=mod_df1_Listeria.rawdata,aes(x=VariableKit,y=LogCopiespermLofMilk)) +
  geom_point(data=mod_df2_Listeria.best.model,aes(x=VariableKit,y=emmean,fill=VariableKit))+
  geom_errorbar(data=mod_df2_Listeria.best.model,aes(x=VariableKit,ymin=lower.CL,ymax=upper.CL),width=0.5)

# Making the plot pretty

Colors <- c("COREDNA" = "#4DB3C7", "EZFood"= "#85CA46", "Mastitis"= "#F49D00","Pfood"= "#D2326B", "PSoilP"="#1D6E9B", "PviralDNA"= "#6850B4", "ZymoDNA"="#165F05")
  
ggplot() +
  geom_jitter(data=mod_df1_Listeria.rawdata,aes(x=VariableKit,y=LogCopiespermLofMilk,color=VariableKit, shape=SpikeSet)) +
  scale_color_manual(values=Colors)+
  geom_errorbar(data=mod_df2_Listeria.best.model,aes(x=VariableKit,ymin=lower.CL,ymax=upper.CL),width=0.3)+  
  geom_point(data=mod_df2_Listeria.best.model,aes(x=VariableKit,y=emmean,fill=VariableKit))+
  geom_text(data =data.frame(mod.Listeria.best_cld_letters),aes(x=VariableKit,label=`.group`, y=emmean), nudge_y = 0.2, nudge_x = -0.05, fontface = "bold") +
#ylim(3.5, 6.5)+
xlab("Kit")+
ylab ("Log10 Copies / mL of Milk")+
  theme_bw()+
  ggtitle("Listeria Copy Numbers - Inoculated Milk Only - Not assuming homoscedasticity ")+
  scale_color_manual(values=Colors)+
  theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  theme(axis.text.x=element_text(angle=25,vjust=0.5))+
scale_x_discrete(limits=c("COREDNA", "Mastitis", "EZFood",  "Pfood", "PSoilP", "PviralDNA", "ZymoDNA"))

```

***
<style>
div.type0 { background-color:#BFBFBF; border-radius: 5px; padding: 20px;}
</style>
<div class = "type0">
<p style="color:black;font-size:15px;"> <b> 
Model not assuming homoscedasticity and including VariableKit + SpikeSet + qPCRefficiency was chosen.<br> qPCRefficiency is forced into all final models </b>

Formula: mod.Listeria = nlme::gls(LogCopiespermLofMilk ~ VariableKit + qPCRefficiency + SpikeSet, data=Listeria.InnOnly,
                 weights = varIdent(form = ~1 | VariableKit))<br>
<br>
<b>AIC(mod.Listeria) <br>
-136.564 # best model<br>
 <br> </b>


Previously chosen Linear Model that assumed homoscedasticity for reference: <br>
m_Listeria.LogCopiespermLofMilk3 <- lm( LogCopiespermLofMilk ~ VariableKit + qPCRefficiency + SpikeSet, data=Listeria.InnOnly ) <br>
AIC(m_Listeria.LogCopiespermLofMilk3) <br>
-126.1634 <br>

</p>
</div>

***


***
<style>
div.type2 { background-color:#66C2A5; border-radius: 15px; padding: 20px;}
</style>
<div class = "type2">
<p style="color:black;font-size:20px;"> <b>Manuscript Figures: Listeria </b></p>
</div>

***

```{r}
# Listeria: Milk Data and Controls
Listeria.Inn.Ctrl <- Listeria %>% filter(VariableSampleType!="NP40InoculatedMilk")
dim(Listeria.Inn.Ctrl)

Colors <- c("COREDNA" = "#4DB3C7", "EZFood"= "#85CA46", "Mastitis"= "#F49D00","Pfood"= "#D2338B", "PSoilP"="#1D6E9B", "PviralDNA"= "#6850B4", "ZymoDNA"="#165F05")


Listeria.Inn.Ctrl$VariableSampleType <- factor(Listeria.Inn.Ctrl$VariableSampleType, levels=c('InoculatedMilk', 'UninoculatedMilk', 'NoTemplateControl', 'MockCommunity'))

ggplot(data=Listeria.Inn.Ctrl, aes(VariableKit,LogCopiespermLofMilk, color= VariableKit, shape=SpikeSet))+
  scale_shape_discrete(solid=F) +
  ylab ("Listeria Log10 Copies / mL of Milk")+  
  xlab ("Kit")+
  geom_point(aes(colour = VariableKit), size = 2, stroke = .5, position=position_jitterdodge(jitter.width=0, dodge.width = 1),show.legend = F) +
  facet_wrap(vars(VariableSampleType),nrow = 1)+
  ggtitle("Listeria DNA Copy Numbers - All Samples and Controls")+
  theme_bw()+
  ylim(0, 9)+
  scale_color_manual(values=Colors)+
  theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  theme(axis.text.x=element_text(angle=90,vjust=0.5))+
  scale_x_discrete(limits=c("COREDNA", "Mastitis", "EZFood",  "Pfood", "PSoilP", "PviralDNA", "ZymoDNA"))

ggsave("Listeria-AllSamples.TIFF", width = 9, height = 3,units = "in", dpi = 600)

ggplot(Listeria.InnOnly, aes(VariableKit,LogCopiespermLofMilk,shape = factor(SpikeSet))) +
  scale_shape_discrete(solid=F) +
  geom_point(aes(colour = VariableKit), size = 2, stroke = 1, position=position_jitterdodge(jitter.width=0, dodge.width = 1)) +
  ylab ("Log10 Copies / mL of Milk")+
  xlab ("Kit")+
  ggtitle("Listeria DNA Copy Numbers - Inoculated Milk Only")+
  theme_bw()+
  scale_color_manual(values=Colors)+
  theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  theme(axis.text.x=element_text(angle=25,vjust=0.5))+
  scale_x_discrete(limits=c("COREDNA", "Mastitis", "EZFood",  "Pfood", "PSoilP", "PviralDNA", "ZymoDNA"))
```

```{r}
# Plot overlaying model estimates to raw data
mod_df1_Listeria.rawdata<- Listeria.InnOnly[c(25,42,4)]

mod_df2_Listeria.best.model<-emmeans(mod.Listeria.best,~VariableKit, mode = "df.error") %>%
  summary() %>%
  data.frame()

ggplot() +
  geom_jitter(data=mod_df1_Listeria.rawdata,aes(x=VariableKit,y=LogCopiespermLofMilk,color=VariableKit, shape=SpikeSet), size = 2,stroke = 1, width = .2 ) +
   scale_shape_discrete(solid=F) +
  scale_color_manual(values=Colors)+
  geom_errorbar(data=mod_df2_Listeria.best.model,aes(x=VariableKit,ymin=lower.CL,ymax=upper.CL),width=0.3)+  
  geom_point(data=mod_df2_Listeria.best.model,aes(x=VariableKit,y=emmean,fill=VariableKit))+
  geom_text(data =data.frame(mod.Listeria.best_cld_letters),aes(x=VariableKit,label=`.group`, y=emmean), nudge_y = .3, nudge_x = -0.05, fontface = "bold") +
#ylim(3.5, 6.5)+
ylab ("Log10 Copies / mL of Milk")+
  xlab ("Kit")+
  ggtitle("Listeria DNA Copy Numbers - Inoculated Milk Only")+
   theme_bw()+
   theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  scale_x_discrete(limits=c("COREDNA", "Mastitis", "EZFood",  "Pfood", "PSoilP", "PviralDNA", "ZymoDNA"))

ggsave("Listeria-Model-Jitter.TIFF", width = 7.5, height = 3.5 , units = "in", dpi = 600)


ggplot() +
  geom_point(data=mod_df1_Listeria.rawdata,aes(x=VariableKit,y=LogCopiespermLofMilk,color=VariableKit, shape=SpikeSet), size = 2, stroke = 1, position=position_jitterdodge(jitter.width=0, dodge.width = .5)) +
   scale_shape_discrete(solid=F) +
  scale_color_manual(values=Colors)+
  geom_errorbar(data=mod_df2_Listeria.best.model,aes(x=VariableKit,ymin=lower.CL,ymax=upper.CL),width=0.3)+  
  geom_point(data=mod_df2_Listeria.best.model,aes(x=VariableKit,y=emmean,fill=VariableKit))+
  geom_text(data =data.frame(mod.Listeria.best_cld_letters),aes(x=VariableKit,label=`.group`, y=emmean), nudge_y = .3, nudge_x = -0.05, fontface = "bold") +
#ylim(3.5, 6.5)+
ylab ("Log10 Copies / mL of Milk")+
  xlab ("Kit")+
  ggtitle("Listeria DNA Copy Numbers - Inoculated Milk Only")+
   theme_bw()+
   theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  scale_x_discrete(limits=c("COREDNA", "Mastitis", "EZFood",  "Pfood", "PSoilP", "PviralDNA", "ZymoDNA"))
ggsave("Listeria-Model.TIFF", width = 7.5, height = 3.5 , units = "in", dpi = 600)
```

***
<style>
div.type1 { background-color:#000000; border-radius: 5px; padding: 20px;}
</style>
<div class = "type1">
<p style="color:white;font-size:60px;"> <b> <i>Mycobacterium </i> </b></p>
</div>

***

# Mycobacterium smegmatis Copy Numbers
```{r}
#Data File: CleanDNAprepData1.18.19
library(ggplot2)
library(dplyr)
library(emmeans)
library(multcompView)

#Filter Subset from Sample Data
Mycobacterium <- SampleData %>% filter(Assay=="Mycobacterium smegmatis")
dim(Mycobacterium)

#Summary Statistics

Mycobacterium.summary <- Mycobacterium %>%
  group_by(VariableKit,VariableSampleType) %>%
  summarize(mean_LogCopiespermLofMilk=mean(LogCopiespermLofMilk,na.rm=T),
            st_dev=sd(LogCopiespermLofMilk,na.rm=T),
            n_missing=sum(is.na(LogCopiespermLofMilk)),
            n_total=n())%>%
  data.frame()
  
write.table (Mycobacterium.summary, "Mycobacterium.summary.txt", sep="\t" )
```

```{r}
#Plot Raw Means and Standard Deviations
Colors <- c("COREDNA" = "#4DB3C7", "EZFood"= "#85CA46", "Mastitis"= "#F49D00","Pfood"= "#D2326B", "PSoilP"="#1D6E9B", "PviralDNA"= "#6850B4", "ZymoDNA"="#165F05")
ggplot(data=Mycobacterium,
       mapping=aes(x=VariableSampleType,y=LogCopiespermLofMilk,z=VariableKit, color=VariableKit, ylab="Copy Numbers")) +
  ylab ("Log10 Copies / mL of Milk")+
  geom_boxplot(lwd=1)+
  theme_bw()+
  ggtitle("Mycobacterium Copy Numbers")+
  scale_color_manual(values=Colors)+
  theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  theme(axis.text.x=element_text(angle=25,vjust=0.5))+
  scale_x_discrete(limits=c("UninoculatedMilk", "InoculatedMilk", "NP40InoculatedMilk",  "MockCommunity", "NoTemplateControl"))






ggplot(data=Mycobacterium,
       mapping=aes(x=VariableSampleType,y=LogCopiespermLofMilk, color=VariableKit, shape=SpikeSet)) +
  ylab ("Log10 Copies / mL of Milk")+
      geom_jitter(width=0.25)+
  ggtitle("Mycobacterium Copy Numbers")+
  theme_bw()+
  scale_color_manual(values=Colors)+
  theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  theme(axis.text.x=element_text(angle=25,vjust=0.5))+
  scale_x_discrete(limits=c("UninoculatedMilk", "InoculatedMilk", "NP40InoculatedMilk",  "MockCommunity", "NoTemplateControl"))


ggplot(data=Mycobacterium,
       mapping=aes(x=VariableSampleType,y=LogCopiespermLofMilk, color=SpikeSet, shape=VariableKit)) +
  ylab ("Log10 Copies / mL of Milk")+
    geom_jitter(width=0.35)+
  ggtitle("Mycobacterium Copy Numbers")+
  theme_bw()+
  theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  theme(axis.text.x=element_text(angle=25,vjust=0.5))
```

```{r}
# Inoculated Milk Data
Mycobacterium.InnOnly <- Mycobacterium %>% filter(VariableSampleType=="InoculatedMilk", LogCopiespermLofMilk>0.001)
Mycobacterium.InnOnly %>%
  group_by(VariableSampleType, VariableSpikeSet, VariableKit) %>%
  summarize(mean_LogCopiespermLofMilk=mean(LogCopiespermLofMilk,na.rm=T),
            st_dev=sd(LogCopiespermLofMilk,na.rm=T),
            n_missing=sum(is.na(LogCopiespermLofMilk)),
            n_total=n())%>%
  data.frame()
```
## Model Selection
### Linear Models
```{r}
#3 linear models were compared: including SpikeSet only, qPCRefficiency only, and both as covariates. Best model fit was used as the final model. 
m_Mycobacterium.LogCopiespermLofMilk1 <- lm( LogCopiespermLofMilk ~ VariableKit + SpikeSet, data=Mycobacterium.InnOnly )
summary(m_Mycobacterium.LogCopiespermLofMilk1)

m_Mycobacterium.LogCopiespermLofMilk2 <- lm( LogCopiespermLofMilk ~ VariableKit + qPCRefficiency, data=Mycobacterium.InnOnly )
summary(m_Mycobacterium.LogCopiespermLofMilk2)

m_Mycobacterium.LogCopiespermLofMilk3 <- lm( LogCopiespermLofMilk ~ VariableKit + qPCRefficiency + SpikeSet, data=Mycobacterium.InnOnly )
summary(m_Mycobacterium.LogCopiespermLofMilk3)

# Fit of model with both qPCRefficiency and SpikeSet is better than fit of model with SpikeSet only
anova(m_Mycobacterium.LogCopiespermLofMilk1, m_Mycobacterium.LogCopiespermLofMilk2, m_Mycobacterium.LogCopiespermLofMilk3)

AIC(m_Mycobacterium.LogCopiespermLofMilk1)
AIC(m_Mycobacterium.LogCopiespermLofMilk2)
AIC(m_Mycobacterium.LogCopiespermLofMilk3)
# Final model chosen:
# Model 3:  LogCopiespermLofMilk ~ VariableKit + qPCRefficiency + SpikeSet
#m_Mycobacterium.LogCopiespermLofMilk3 <- lm( LogCopiespermLofMilk ~ VariableKit + qPCRefficiency + SpikeSet, data=Mycobacterium.InnOnly )

```
### Mixed effects models - for reference
```{r}
library(lme4)
library(lmerTest)

model1 = lmer(LogCopiespermLofMilk ~ VariableKit + (1|SpikeSet),
            data=Mycobacterium.InnOnly,
            REML=TRUE)
summary(model1)

model2 = lmer(LogCopiespermLofMilk ~ VariableKit + qPCRefficiency + (1|SpikeSet),
            data=Mycobacterium.InnOnly,
            REML=TRUE)
summary(model2)

anova(model1, model2)
AIC (model1)
AIC (model2)
```

## Final Model
```{r}
m_Mycobacterium.LogCopiespermLofMilk <- lm( LogCopiespermLofMilk ~ VariableKit + qPCRefficiency + SpikeSet, data=Mycobacterium.InnOnly )
summary(m_Mycobacterium.LogCopiespermLofMilk)


plot(x=predict(m_Mycobacterium.LogCopiespermLofMilk),y=resid(m_Mycobacterium.LogCopiespermLofMilk))

  # using ggplot2
Colors <- c("COREDNA" = "#4DB3C7", "EZFood"= "#85CA46", "Mastitis"= "#F49D00","Pfood"= "#D2326B", "PSoilP"="#1D6E9B", "PviralDNA"= "#6850B4", "ZymoDNA"="#165F05")
 
ggplot(m_Mycobacterium.LogCopiespermLofMilk, aes(x=predict(m_Mycobacterium.LogCopiespermLofMilk), y=resid(m_Mycobacterium.LogCopiespermLofMilk), color=VariableKit)) +
  geom_point()+
  theme_bw()+
  ggtitle("Mycobacterium Innoculated Only - Model Fit - Residuals vs Predicted")+
  scale_color_manual(values=Colors)+
  theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  geom_hline(yintercept = 1) +
  geom_hline(yintercept = -1)

  # qqplots
qqnorm(resid(m_Mycobacterium.LogCopiespermLofMilk))
qqline(resid(m_Mycobacterium.LogCopiespermLofMilk))
summary(m_Mycobacterium.LogCopiespermLofMilk)

# Only 1 large residual was identified, and it belonged to EZfood

Mycobacterium.InnOnly$resid <- resid(m_Mycobacterium.LogCopiespermLofMilk)
Mycobacterium.InnOnly %>% 
  filter(abs(resid)>1) %>%
  select(VariableKit,resid) %>%
  group_by(VariableKit) %>%
  summarize(n=n())

```

```{r}
# Check Tukey-adjusted pairwise comparison of kit estimates
m_Mycobacterium.LogCopiespermLofMilk_emmeans <- emmeans(m_Mycobacterium.LogCopiespermLofMilk,pairwise~VariableKit)
# Use compact letter display for convenience
m_Mycobacterium.LogCopiespermLofMilk_cld <- CLD(m_Mycobacterium.LogCopiespermLofMilk_emmeans$emmeans,
                                         Letters=LETTERS)
m_Mycobacterium.LogCopiespermLofMilk_cld

# Get fitted values from model to plot with other software
emmeans(m_Mycobacterium.LogCopiespermLofMilk,~ VariableKit) %>%
  summary() %>%
  data.frame() 

# Plot fitted values from model
Colors <- c("COREDNA" = "#4DB3C7", "EZFood"= "#85CA46", "Mastitis"= "#F49D00","Pfood"= "#D2326B", "PSoilP"="#1D6E9B", "PviralDNA"= "#6850B4", "ZymoDNA"="#165F05")

emmeans(m_Mycobacterium.LogCopiespermLofMilk,~VariableKit) %>%
  summary() %>%
  data.frame() %>%
  ggplot(aes(x=VariableKit,y=emmean,color=VariableKit)) +
  geom_point() +
  labs(y="Estimated Marginal Means") +
  geom_errorbar(aes(ymin=lower.CL,ymax=upper.CL),width=0.5) +
  geom_text(data=data.frame(m_Mycobacterium.LogCopiespermLofMilk_cld),aes(x=VariableKit,label=`.group`),hjust=-.1) +
  theme_bw()+
  ggtitle("Mycobacterium Copy Numbers - Inoculated Milk Only")+
  scale_color_manual(values=Colors)+
  theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  theme(axis.text.x=element_text(angle=25,vjust=0.5))+
  scale_x_discrete(limits=c("COREDNA", "Mastitis", "EZFood",  "Pfood", "PSoilP", "PviralDNA", "ZymoDNA"))

```

## Mycobacterium - Models not assuming homoscedasticity

```{r}
# from https://cran.r-project.org/web/packages/emmeans/vignettes/FAQs.html#contents

library(nlme)
# Final model chosen:
# Model 3:  LogCopiespermLofMilk ~ VariableKit + qPCRefficiency + SpikeSet
# m_Mycobacterium.LogCopiespermLofMilk3 <- lm( LogCopiespermLofMilk ~ VariableKit + qPCRefficiency + SpikeSet, data=Mycobacterium.InnOnly )

mod.Mycobacterium = nlme::gls(LogCopiespermLofMilk ~ VariableKit + qPCRefficiency + SpikeSet, data=Mycobacterium.InnOnly,
                 weights = varIdent(form = ~1 | VariableKit))
summary(mod.Mycobacterium)

AIC(m_Mycobacterium.LogCopiespermLofMilk3)
AIC(mod.Mycobacterium)

# Testing simpler model

mod3.Mycobacterium = nlme::gls(LogCopiespermLofMilk ~ VariableKit, data=Mycobacterium.InnOnly,
                 weights = varIdent(form = ~1 | VariableKit))
summary(mod3.Mycobacterium)

AIC(m_Mycobacterium.LogCopiespermLofMilk3)
AIC(mod.Mycobacterium)
AIC(mod3.Mycobacterium) #mod.Mycobacterium is best model (including qPCRefficiency and SpikeSet)

#mod.Mycobacterium not assuming homoscedasticity and including qPCRefficiency and SpikeSet is a much better fit than any of the alternatives

mod.Mycobacterium.best <- mod.Mycobacterium

```

### Final Mycobacterium Figure
```{r}

# Check Tukey-adjusted pairwise comparison of kit estimates
mod.Mycobacterium_emmeans <- emmeans(mod.Mycobacterium,pairwise~VariableKit)
# Use compact letter display for convenience
mod.Mycobacterium_cld <- CLD(mod.Mycobacterium_emmeans$emmeans, sort=TRUE, details=TRUE, Letters=LETTERS)
mod.Mycobacterium_cld_letters <- CLD(mod.Mycobacterium_emmeans$emmeans, Letters=LETTERS)
mod.Mycobacterium_cld

# Get fitted values from model to plot with other software
emmeans(mod.Mycobacterium,~ VariableKit) %>%
  summary() %>%
  data.frame() 

# Get summary
summary(emmeans(mod.Mycobacterium,~ VariableKit), infer=TRUE)

# Plot overlaying model estimates to raw data
mod.Mycobacterium_df1_Mycobacterium.rawdata<-Mycobacterium.InnOnly[c(25,42,4)]

mod.Mycobacterium_df2_Mycobacterium.model<-emmeans(mod.Mycobacterium,~VariableKit) %>%
  summary() %>%
  data.frame()

ggplot() +
  geom_jitter(data=mod.Mycobacterium_df1_Mycobacterium.rawdata,aes(x=VariableKit,y=LogCopiespermLofMilk)) +
  geom_point(data=mod.Mycobacterium_df2_Mycobacterium.model,aes(x=VariableKit,y=emmean,fill=VariableKit))+
  geom_errorbar(data=mod.Mycobacterium_df2_Mycobacterium.model,aes(x=VariableKit,ymin=lower.CL,ymax=upper.CL),width=0.5)

# Making the plot pretty

Colors <- c("COREDNA" = "#4DB3C7", "EZFood"= "#85CA46", "Mastitis"= "#F49D00","Pfood"= "#D2326B", "PSoilP"="#1D6E9B", "PviralDNA"= "#6850B4", "ZymoDNA"="#165F05")


ggplot() +
  geom_jitter(data=mod.Mycobacterium_df1_Mycobacterium.rawdata,aes(x=VariableKit,y=LogCopiespermLofMilk, color=VariableKit, shape=SpikeSet)) +
  scale_color_manual(values=Colors)+
   geom_errorbar(data=mod.Mycobacterium_df2_Mycobacterium.model,aes(x=VariableKit,ymin=lower.CL,ymax=upper.CL),width=0.5)+
   geom_point(data=mod.Mycobacterium_df2_Mycobacterium.model,aes(x=VariableKit,y=emmean,fill=VariableKit))+
  geom_text(data =data.frame(mod.Mycobacterium_cld_letters),aes(x=VariableKit,label=`.group`, y=emmean), nudge_y = 0.2, nudge_x = -0.05, fontface = "bold")+
ylim(2.5, 8.0)+
xlab("Kit")+
ylab ("Log10 Copies / mL of Milk")+
  theme_bw()+
  ggtitle("Mycobacterium Copy Numbers - Inoculated Milk Only - Not assuming homoscedasticity ")+
  scale_color_manual(values=Colors)+
  theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  theme(axis.text.x=element_text(angle=25,vjust=0.5))+
scale_x_discrete(limits=c("COREDNA", "Mastitis", "EZFood",  "Pfood", "PSoilP", "PviralDNA", "ZymoDNA"))
```


### Mycobacterium Figure
```{r}
library(emmeans)
# Check Tukey-adjusted pairwise comparison of kit estimates
mod.Mycobacterium.best_emmeans <- emmeans(mod.Mycobacterium.best,pairwise~VariableKit, mode = "df.error")

# Use compact letter display for convenience
mod.Mycobacterium.best_cld <- CLD(mod.Mycobacterium.best_emmeans$emmeans, sort=TRUE, details=TRUE, Letters=LETTERS)
mod.Mycobacterium.best_cld_letters <- CLD(mod.Mycobacterium.best_emmeans$emmeans, Letters=LETTERS)
mod.Mycobacterium.best_cld_letters

# Get fitted values from model to plot with other software
emmeans(mod.Mycobacterium.best,~ VariableKit,mode = "df.error") %>%
  summary() %>%
  data.frame() 

# Get summary
summary(emmeans(mod.Mycobacterium.best,~ VariableKit,mode = "df.error"), infer=TRUE)

# Plot overlaying model estimates to raw data
mod_df1_Mycobacterium.rawdata<-Mycobacterium.InnOnly[c(25,42,4)]

mod_df2_Mycobacterium.best.model<-emmeans(mod.Mycobacterium.best,~VariableKit, mode = "df.error") %>%
  summary() %>%
  data.frame()

ggplot() +
  geom_jitter(data=mod_df1_Mycobacterium.rawdata,aes(x=VariableKit,y=LogCopiespermLofMilk)) +
  geom_point(data=mod_df2_Mycobacterium.best.model,aes(x=VariableKit,y=emmean,fill=VariableKit))+
  geom_errorbar(data=mod_df2_Mycobacterium.best.model,aes(x=VariableKit,ymin=lower.CL,ymax=upper.CL),width=0.5)

# Making the plot pretty

Colors <- c("COREDNA" = "#4DB3C7", "EZFood"= "#85CA46", "Mastitis"= "#F49D00","Pfood"= "#D2326B", "PSoilP"="#1D6E9B", "PviralDNA"= "#6850B4", "ZymoDNA"="#165F05")
  
ggplot() +
  geom_jitter(data=mod_df1_Mycobacterium.rawdata,aes(x=VariableKit,y=LogCopiespermLofMilk,color=VariableKit, shape=SpikeSet)) +
  scale_color_manual(values=Colors)+
  geom_errorbar(data=mod_df2_Mycobacterium.best.model,aes(x=VariableKit,ymin=lower.CL,ymax=upper.CL),width=0.3)+  
  geom_point(data=mod_df2_Mycobacterium.best.model,aes(x=VariableKit,y=emmean,fill=VariableKit))+
  geom_text(data =data.frame(mod.Mycobacterium.best_cld_letters),aes(x=VariableKit,label=`.group`, y=emmean), nudge_y = 0.2, nudge_x = -0.05, fontface = "bold") +
#ylim(3.5, 6.5)+
xlab("Kit")+
ylab ("Log10 Copies / mL of Milk")+
  theme_bw()+
  ggtitle("Mycobacterium Copy Numbers - Inoculated Milk Only - Not assuming homoscedasticity ")+
  scale_color_manual(values=Colors)+
  theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  theme(axis.text.x=element_text(angle=25,vjust=0.5))+
scale_x_discrete(limits=c("COREDNA", "Mastitis", "EZFood",  "Pfood", "PSoilP", "PviralDNA", "ZymoDNA"))

```

***
<style>
div.type0 { background-color:#BFBFBF; border-radius: 5px; padding: 20px;}
</style>
<div class = "type0">
<p style="color:black;font-size:15px;"> <b> 
Model not assuming homoscedasticity and including VariableKit + SpikeSet + qPCRefficiency was chosen.<br> qPCRefficiency is forced into all final models </b>

Formula: mod.Mycobacterium = nlme::gls(LogCopiespermLofMilk ~ VariableKit + qPCRefficiency + SpikeSet, data=Mycobacterium.InnOnly,
                 weights = varIdent(form = ~1 | VariableKit))<br>
<br>
<b> AIC(mod.Mycobacterium) # best model<br>
-80.071 <br> </b>
 <br>
<br>
Other Models for Reference: <br>
<br>
mod3.Mycobacterium = nlme::gls(LogCopiespermLofMilk ~ VariableKit, data=Mycobacterium.InnOnly,
                 weights = varIdent(form = ~1 | VariableKit))<br>
AIC(mod3.Mycobacterium) <br>
185.8061<br>


Previously chosen Linear Model that assumed homoscedasticity for reference: <br>
m_Mycobacterium.LogCopiespermLofMilk3 <- lm( LogCopiespermLofMilk ~ VariableKit + qPCRefficiency + SpikeSet, data=Mycobacterium.InnOnly ) <br>
AIC(m_Mycobacterium.LogCopiespermLofMilk3)<br>
27.08939<br>
</p>
</div>

***


***
<style>
div.type2 { background-color:#66C2A5; border-radius: 15px; padding: 20px;}
</style>
<div class = "type2">
<p style="color:black;font-size:20px;"> <b>Manuscript Figures: Mycobacterium </b></p>
</div>

***

```{r}
# Mycobacterium: Milk Data and Controls
Mycobacterium.Inn.Ctrl <- Mycobacterium %>% filter(VariableSampleType!="NP40InoculatedMilk")
dim(Mycobacterium.Inn.Ctrl)

Colors <- c("COREDNA" = "#4DB3C7", "EZFood"= "#85CA46", "Mastitis"= "#F49D00","Pfood"= "#D2338B", "PSoilP"="#1D6E9B", "PviralDNA"= "#6850B4", "ZymoDNA"="#165F05")


Mycobacterium.Inn.Ctrl$VariableSampleType <- factor(Mycobacterium.Inn.Ctrl$VariableSampleType, levels=c('InoculatedMilk', 'UninoculatedMilk', 'NoTemplateControl', 'MockCommunity'))

ggplot(data=Mycobacterium.Inn.Ctrl, aes(VariableKit,LogCopiespermLofMilk, color= VariableKit, shape=SpikeSet))+
  scale_shape_discrete(solid=F) +
  ylab ("Mycobacterium Log10 Copies / mL of Milk")+  
  xlab ("Kit")+
  geom_point(aes(colour = VariableKit), size = 2, stroke = .5, position=position_jitterdodge(jitter.width=0, dodge.width = 1), show.legend = F) +
  facet_wrap(vars(VariableSampleType),nrow = 1)+
  ggtitle("Mycobacterium DNA Copy Numbers - All Samples and Controls")+
  theme_bw()+
  ylim(0, 9)+
  scale_color_manual(values=Colors)+
  theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  theme(axis.text.x=element_text(angle=90,vjust=0.5))+
  scale_x_discrete(limits=c("COREDNA", "Mastitis", "EZFood",  "Pfood", "PSoilP", "PviralDNA", "ZymoDNA"))

ggsave("Mycobacterium-AllSamples.TIFF", width = 9, height = 3,units = "in", dpi = 600)

ggplot(Mycobacterium.InnOnly, aes(VariableKit,LogCopiespermLofMilk,shape = factor(SpikeSet))) +
  scale_shape_discrete(solid=F) +
  geom_point(aes(colour = VariableKit), size = 2, stroke = 1, position=position_jitterdodge(jitter.width=0, dodge.width = 1)) +
  ylab ("Log10 Copies / mL of Milk")+
  xlab ("Kit")+
  ggtitle("Mycobacterium DNA Copy Numbers - Inoculated Milk Only")+
  theme_bw()+
  scale_color_manual(values=Colors)+
  theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  theme(axis.text.x=element_text(angle=25,vjust=0.5))+
  scale_x_discrete(limits=c("COREDNA", "Mastitis", "EZFood",  "Pfood", "PSoilP", "PviralDNA", "ZymoDNA"))
```

```{r}
# Plot overlaying model estimates to raw data
mod_df1_Mycobacterium.rawdata<- Mycobacterium.InnOnly[c(25,42,4)]

mod_df2_Mycobacterium.best.model<-emmeans(mod.Mycobacterium.best,~VariableKit, mode = "df.error") %>%
  summary() %>%
  data.frame()

ggplot() +
  geom_jitter(data=mod_df1_Mycobacterium.rawdata,aes(x=VariableKit,y=LogCopiespermLofMilk,color=VariableKit, shape=SpikeSet), size = 2,stroke = 1, width = .2 ) +
   scale_shape_discrete(solid=F) +
  scale_color_manual(values=Colors)+
  geom_errorbar(data=mod_df2_Mycobacterium.best.model,aes(x=VariableKit,ymin=lower.CL,ymax=upper.CL),width=0.3)+  
  geom_point(data=mod_df2_Mycobacterium.best.model,aes(x=VariableKit,y=emmean,fill=VariableKit))+
  geom_text(data =data.frame(mod.Mycobacterium.best_cld_letters),aes(x=VariableKit,label=`.group`, y=emmean), nudge_y = 1.2, nudge_x = -0.05, fontface = "bold") +
#ylim(3.5, 6.5)+
ylab ("Log10 Copies / mL of Milk")+
  xlab ("Kit")+
  ggtitle("Mycobacterium DNA Copy Numbers - Inoculated Milk Only")+
   theme_bw()+
   theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  scale_x_discrete(limits=c("COREDNA", "Mastitis", "EZFood",  "Pfood", "PSoilP", "PviralDNA", "ZymoDNA"))

ggsave("Mycobacterium-Model-Jitter.TIFF", width = 7.5, height = 3.5 , units = "in", dpi = 600)


ggplot() +
  geom_point(data=mod_df1_Mycobacterium.rawdata,aes(x=VariableKit,y=LogCopiespermLofMilk,color=VariableKit, shape=SpikeSet), size = 2, stroke = 1, position=position_jitterdodge(jitter.width=0, dodge.width = .5)) +
   scale_shape_discrete(solid=F) +
  scale_color_manual(values=Colors)+
  geom_errorbar(data=mod_df2_Mycobacterium.best.model,aes(x=VariableKit,ymin=lower.CL,ymax=upper.CL),width=0.3)+  
  geom_point(data=mod_df2_Mycobacterium.best.model,aes(x=VariableKit,y=emmean,fill=VariableKit))+
  geom_text(data =data.frame(mod.Mycobacterium.best_cld_letters),aes(x=VariableKit,label=`.group`, y=emmean), nudge_y = 1.2, nudge_x = -0.05, fontface = "bold") +
#ylim(3.5, 6.5)+
ylab ("Log10 Copies / mL of Milk")+
  xlab ("Kit")+
  ggtitle("Mycobacterium DNA Copy Numbers - Inoculated Milk Only")+
   theme_bw()+
   theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  scale_x_discrete(limits=c("COREDNA", "Mastitis", "EZFood",  "Pfood", "PSoilP", "PviralDNA", "ZymoDNA"))
ggsave("Mycobacterium-Model.TIFF", width = 7.5, height = 3.5 , units = "in", dpi = 600)
```



***
<style>
div.type1 { background-color:#000000; border-radius: 5px; padding: 20px;}
</style>
<div class = "type1">
<p style="color:white;font-size:60px;"> <b> <i>Salmonella </i> </b></p>
</div>

***


# Salmonella sp. Copy Numbers
```{r}
#Data File: CleanDNAprepData1.18.19
library(ggplot2)
library(dplyr)
library(emmeans)
library(multcompView)

#Filter Subset from Sample Data
Salmonella <- SampleData %>% filter(Assay=="Salmonella sp.")
dim(Salmonella)

#Summary Statistics

Salmonella.summary <- Salmonella %>%
  group_by(VariableKit,VariableSampleType) %>%
  summarize(mean_LogCopiespermLofMilk=mean(LogCopiespermLofMilk,na.rm=T),
            st_dev=sd(LogCopiespermLofMilk,na.rm=T),
            n_missing=sum(is.na(LogCopiespermLofMilk)),
            n_total=n())%>%
  data.frame()
  
write.table (Salmonella.summary, "Salmonella.summary.txt", sep="\t" )
```

```{r}
#Plot Raw Means and Standard Deviations
Colors <- c("COREDNA" = "#4DB3C7", "EZFood"= "#85CA46", "Mastitis"= "#F49D00","Pfood"= "#D2326B", "PSoilP"="#1D6E9B", "PviralDNA"= "#6850B4", "ZymoDNA"="#165F05")
ggplot(data=Salmonella,
       mapping=aes(x=VariableSampleType,y=LogCopiespermLofMilk,z=VariableKit, color=VariableKit, ylab="Copy Numbers")) +
  ylab ("Log10 Copies / mL of Milk")+
  geom_boxplot(lwd=1)+
  theme_bw()+
  ggtitle("Salmonella Copy Numbers")+
  scale_color_manual(values=Colors)+
  theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  theme(axis.text.x=element_text(angle=25,vjust=0.5))+
  scale_x_discrete(limits=c("UninoculatedMilk", "InoculatedMilk", "NP40InoculatedMilk",  "MockCommunity", "NoTemplateControl"))



ggplot(data=Salmonella,
       mapping=aes(x=VariableSampleType,y=LogCopiespermLofMilk, color=VariableKit, shape=SpikeSet)) +
  ylab ("Log10 Copies / mL of Milk")+
      geom_jitter(width=0.25)+
  ggtitle("Salmonella Copy Numbers")+
  theme_bw()+
  scale_color_manual(values=Colors)+
  theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  theme(axis.text.x=element_text(angle=25,vjust=0.5))


ggplot(data=Salmonella,
       mapping=aes(x=VariableSampleType,y=LogCopiespermLofMilk, color=SpikeSet)) +
  ylab ("Log10 Copies / mL of Milk")+
    geom_jitter(width=0.35)+
  ggtitle("Salmonella Copy Numbers")+
  theme_bw()+
  theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  theme(axis.text.x=element_text(angle=25,vjust=0.5))+
  scale_x_discrete(limits=c("UninoculatedMilk", "InoculatedMilk", "NP40InoculatedMilk",  "MockCommunity", "NoTemplateControl"))
```

```{r}
# Inoculated Milk Data
Salmonella.InnOnly <- Salmonella %>% filter(VariableSampleType=="InoculatedMilk", LogCopiespermLofMilk>0.001)
Salmonella.InnOnly %>%
  group_by(VariableSampleType, VariableSpikeSet, VariableKit) %>%
  summarize(mean_LogCopiespermLofMilk=mean(LogCopiespermLofMilk,na.rm=T),
            st_dev=sd(LogCopiespermLofMilk,na.rm=T),
            n_missing=sum(is.na(LogCopiespermLofMilk)),
            n_total=n())%>%
  data.frame()
```
## Model Selection
### Linear Models
```{r}
#3 linear models were compared: including SpikeSet only, qPCRefficiency only, and both as covariates. Best model fit was used as the final model. 
m_Salmonella.LogCopiespermLofMilk1 <- lm( LogCopiespermLofMilk ~ VariableKit + SpikeSet, data=Salmonella.InnOnly )
summary(m_Salmonella.LogCopiespermLofMilk1)

m_Salmonella.LogCopiespermLofMilk2 <- lm( LogCopiespermLofMilk ~ VariableKit + qPCRefficiency, data=Salmonella.InnOnly )
summary(m_Salmonella.LogCopiespermLofMilk2)

m_Salmonella.LogCopiespermLofMilk3 <- lm( LogCopiespermLofMilk ~ VariableKit + qPCRefficiency + SpikeSet, data=Salmonella.InnOnly )
summary(m_Salmonella.LogCopiespermLofMilk3)

# Fit of model with both qPCRefficiency and SpikeSet is better than fit of model with SpikeSet only
anova(m_Salmonella.LogCopiespermLofMilk1, m_Salmonella.LogCopiespermLofMilk2, m_Salmonella.LogCopiespermLofMilk3)

AIC(m_Salmonella.LogCopiespermLofMilk1)
AIC(m_Salmonella.LogCopiespermLofMilk2)
AIC(m_Salmonella.LogCopiespermLofMilk3)
# Final model chosen:
# Model 3:  LogCopiespermLofMilk ~ VariableKit + qPCRefficiency + SpikeSet
# m_Salmonella.LogCopiespermLofMilk3 <- lm( LogCopiespermLofMilk ~ VariableKit + qPCRefficiency + SpikeSet, data=Salmonella.InnOnly )
```
### Mixed effects models - for reference
```{r}
library(lme4)
library(lmerTest)

model1 = lmer(LogCopiespermLofMilk ~ VariableKit + (1|SpikeSet),
            data=Salmonella.InnOnly,
            REML=TRUE)
summary(model1)

model2 = lmer(LogCopiespermLofMilk ~ VariableKit + qPCRefficiency + (1|SpikeSet),
            data=Salmonella.InnOnly,
            REML=TRUE)
summary(model2)

anova(model1, model2)
AIC (model1)
AIC (model2)
```

## Final Model
```{r}
m_Salmonella.LogCopiespermLofMilk <- lm( LogCopiespermLofMilk ~ VariableKit + qPCRefficiency + SpikeSet, data=Salmonella.InnOnly )
summary(m_Salmonella.LogCopiespermLofMilk)


plot(x=predict(m_Salmonella.LogCopiespermLofMilk),y=resid(m_Salmonella.LogCopiespermLofMilk))

  # using ggplot2
Colors <- c("COREDNA" = "#4DB3C7", "EZFood"= "#85CA46", "Mastitis"= "#F49D00","Pfood"= "#D2326B", "PSoilP"="#1D6E9B", "PviralDNA"= "#6850B4", "ZymoDNA"="#165F05")
 
ggplot(m_Salmonella.LogCopiespermLofMilk, aes(x=predict(m_Salmonella.LogCopiespermLofMilk), y=resid(m_Salmonella.LogCopiespermLofMilk), color=VariableKit)) +
  geom_point()+
  theme_bw()+
  ggtitle("Salmonella Innoculated Only - Model Fit - Residuals vs Predicted")+
  scale_color_manual(values=Colors)+
  theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  geom_hline(yintercept = 1) +
  geom_hline(yintercept = -1)

  # qqplots
qqnorm(resid(m_Salmonella.LogCopiespermLofMilk))
qqline(resid(m_Salmonella.LogCopiespermLofMilk))
summary(m_Salmonella.LogCopiespermLofMilk)

# ONly 1 large residual was identified, and it belonged to EZfood

Salmonella.InnOnly$resid <- resid(m_Salmonella.LogCopiespermLofMilk)
Salmonella.InnOnly %>% 
  filter(abs(resid)>1) %>%
  select(VariableKit,resid) %>%
  group_by(VariableKit) %>%
  summarize(n=n())

```

```{r}
# Check Tukey-adjusted pairwise comparison of kit estimates
m_Salmonella.LogCopiespermLofMilk_emmeans <- emmeans(m_Salmonella.LogCopiespermLofMilk,pairwise~VariableKit)
# Use compact letter display for convenience
m_Salmonella.LogCopiespermLofMilk_cld <- CLD(m_Salmonella.LogCopiespermLofMilk_emmeans$emmeans,
                                         Letters=LETTERS)
m_Salmonella.LogCopiespermLofMilk_cld

# Get fitted values from model to plot with other software
emmeans(m_Salmonella.LogCopiespermLofMilk,~ VariableKit) %>%
  summary() %>%
  data.frame() 

# Plot fitted values from model
Colors <- c("COREDNA" = "#4DB3C7", "EZFood"= "#85CA46", "Mastitis"= "#F49D00","Pfood"= "#D2326B", "PSoilP"="#1D6E9B", "PviralDNA"= "#6850B4", "ZymoDNA"="#165F05")
emmeans(m_Salmonella.LogCopiespermLofMilk,~VariableKit) %>%
  summary() %>%
  data.frame() %>%
  ggplot(aes(x=VariableKit,y=emmean,color=VariableKit)) +
  geom_point() +
  labs(y="Estimated Marginal Means") +
  geom_errorbar(aes(ymin=lower.CL,ymax=upper.CL),width=0.5) +
  geom_text(data=data.frame(m_Salmonella.LogCopiespermLofMilk_cld),aes(x=VariableKit,label=`.group`),hjust=-.1) +
  theme_bw()+
  ggtitle("Salmonella Copy Numbers - Inoculated Milk Only")+
  scale_color_manual(values=Colors)+
  theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  theme(axis.text.x=element_text(angle=25,vjust=0.5))+
  scale_x_discrete(limits=c("COREDNA", "Mastitis", "EZFood",  "Pfood", "PSoilP", "PviralDNA", "ZymoDNA"))

```

## Salmonella - Model not assuming homoscedasticity and simpler model

```{r}
# from https://cran.r-project.org/web/packages/emmeans/vignettes/FAQs.html#contents

library(nlme)
# Final model chosen:
# Model 3:  LogCopiespermLofMilk ~ VariableKit + qPCRefficiency + SpikeSet
# m_Salmonella.LogCopiespermLofMilk3 <- lm( LogCopiespermLofMilk ~ VariableKit + qPCRefficiency + SpikeSet, data=Salmonella.InnOnly )

mod.Salmonella = nlme::gls(LogCopiespermLofMilk ~ VariableKit + qPCRefficiency + SpikeSet, data=Salmonella.InnOnly,
                 weights = varIdent(form = ~1 | VariableKit))
summary(mod.Salmonella)

AIC(m_Salmonella.LogCopiespermLofMilk3)
AIC(mod.Salmonella)

# Testing simpler model

mod3.Salmonella = nlme::gls(LogCopiespermLofMilk ~ VariableKit, data=Salmonella.InnOnly,
                 weights = varIdent(form = ~1 | VariableKit))
summary(mod3.Salmonella)

AIC(m_Salmonella.LogCopiespermLofMilk3)
AIC(mod.Salmonella)
AIC(mod3.Salmonella) #mod.Salmonella is best model (including qPCRefficiency and SpikeSet)

#mod.Salmonella not assuming homoscedasticity and including qPCRefficiency and SpikeSet is a much better fit than any of the alternatives

mod.Salmonella.best <- mod.Salmonella
```

### Final Salmonella Figure
```{r}


# Check Tukey-adjusted pairwise comparison of kit estimates
mod.Salmonella_emmeans <- emmeans(mod.Salmonella,pairwise~VariableKit)
# Use compact letter display for convenience
mod.Salmonella_cld <- CLD(mod.Salmonella_emmeans$emmeans, sort=TRUE, details=TRUE, Letters=LETTERS)
mod.Salmonella_cld_letters <- CLD(mod.Salmonella_emmeans$emmeans, Letters=LETTERS)
mod.Salmonella_cld

# Get fitted values from model to plot with other software
emmeans(mod.Salmonella,~ VariableKit) %>%
  summary() %>%
  data.frame() 

# Get summary
summary(emmeans(mod.Salmonella,~ VariableKit), infer=TRUE)

# Plot overlaying model estimates to raw data
mod.Salmonella_df1_Salmonella.rawdata<-Salmonella.InnOnly[c(25,42,4)]

mod.Salmonella_df2_Salmonella.model<-emmeans(mod.Salmonella,~VariableKit) %>%
  summary() %>%
  data.frame()

ggplot() +
  geom_jitter(data=mod.Salmonella_df1_Salmonella.rawdata,aes(x=VariableKit,y=LogCopiespermLofMilk)) +
  geom_point(data=mod.Salmonella_df2_Salmonella.model,aes(x=VariableKit,y=emmean,fill=VariableKit))+
  geom_errorbar(data=mod.Salmonella_df2_Salmonella.model,aes(x=VariableKit,ymin=lower.CL,ymax=upper.CL),width=0.5)

# Making the plot pretty

Colors <- c("COREDNA" = "#4DB3C7", "EZFood"= "#85CA46", "Mastitis"= "#F49D00","Pfood"= "#D2326B", "PSoilP"="#1D6E9B", "PviralDNA"= "#6850B4", "ZymoDNA"="#165F05")


ggplot() +
  geom_jitter(data=mod.Salmonella_df1_Salmonella.rawdata,aes(x=VariableKit,y=LogCopiespermLofMilk, color=VariableKit, shape=SpikeSet)) +
  scale_color_manual(values=Colors)+
   geom_errorbar(data=mod.Salmonella_df2_Salmonella.model,aes(x=VariableKit,ymin=lower.CL,ymax=upper.CL),width=0.5)+
   geom_point(data=mod.Salmonella_df2_Salmonella.model,aes(x=VariableKit,y=emmean,fill=VariableKit))+
  geom_text(data =data.frame(mod.Salmonella_cld_letters),aes(x=VariableKit,label=`.group`, y=emmean), nudge_y = 0.2, nudge_x = -0.05, fontface = "bold")+
ylim(1.5, 7.0)+
xlab("Kit")+
ylab ("Log10 Copies / mL of Milk")+
  theme_bw()+
  ggtitle("Salmonella Copy Numbers - Inoculated Milk Only - Not assuming homoscedasticity ")+
  scale_color_manual(values=Colors)+
  theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  theme(axis.text.x=element_text(angle=25,vjust=0.5))+
scale_x_discrete(limits=c("COREDNA", "Mastitis", "EZFood",  "Pfood", "PSoilP", "PviralDNA", "ZymoDNA"))
```
### Salmonella Figure
```{r}
library(emmeans)
# Check Tukey-adjusted pairwise comparison of kit estimates
mod.Salmonella.best_emmeans <- emmeans(mod.Salmonella.best,pairwise~VariableKit, mode = "df.error")

# Use compact letter display for convenience
mod.Salmonella.best_cld <- CLD(mod.Salmonella.best_emmeans$emmeans, sort=TRUE, details=TRUE, Letters=LETTERS)
mod.Salmonella.best_cld_letters <- CLD(mod.Salmonella.best_emmeans$emmeans, Letters=LETTERS)
mod.Salmonella.best_cld_letters

# Get fitted values from model to plot with other software
emmeans(mod.Salmonella.best,~ VariableKit,mode = "df.error") %>%
  summary() %>%
  data.frame() 

# Get summary
summary(emmeans(mod.Salmonella.best,~ VariableKit,mode = "df.error"), infer=TRUE)

# Plot overlaying model estimates to raw data
mod_df1_Salmonella.rawdata<-Salmonella.InnOnly[c(25,42,4)]

mod_df2_Salmonella.best.model<-emmeans(mod.Salmonella.best,~VariableKit, mode = "df.error") %>%
  summary() %>%
  data.frame()

ggplot() +
  geom_jitter(data=mod_df1_Salmonella.rawdata,aes(x=VariableKit,y=LogCopiespermLofMilk)) +
  geom_point(data=mod_df2_Salmonella.best.model,aes(x=VariableKit,y=emmean,fill=VariableKit))+
  geom_errorbar(data=mod_df2_Salmonella.best.model,aes(x=VariableKit,ymin=lower.CL,ymax=upper.CL),width=0.5)

# Making the plot pretty

Colors <- c("COREDNA" = "#4DB3C7", "EZFood"= "#85CA46", "Mastitis"= "#F49D00","Pfood"= "#D2326B", "PSoilP"="#1D6E9B", "PviralDNA"= "#6850B4", "ZymoDNA"="#165F05")
  
ggplot() +
  geom_jitter(data=mod_df1_Salmonella.rawdata,aes(x=VariableKit,y=LogCopiespermLofMilk,color=VariableKit, shape=SpikeSet)) +
  scale_color_manual(values=Colors)+
  geom_errorbar(data=mod_df2_Salmonella.best.model,aes(x=VariableKit,ymin=lower.CL,ymax=upper.CL),width=0.3)+  
  geom_point(data=mod_df2_Salmonella.best.model,aes(x=VariableKit,y=emmean,fill=VariableKit))+
  geom_text(data =data.frame(mod.Salmonella.best_cld_letters),aes(x=VariableKit,label=`.group`, y=emmean), nudge_y = 0.2, nudge_x = -0.05, fontface = "bold") +
#ylim(3.5, 6.5)+
xlab("Kit")+
ylab ("Log10 Copies / mL of Milk")+
  theme_bw()+
  ggtitle("Salmonella Copy Numbers - Inoculated Milk Only - Not assuming homoscedasticity ")+
  scale_color_manual(values=Colors)+
  theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  theme(axis.text.x=element_text(angle=25,vjust=0.5))+
scale_x_discrete(limits=c("COREDNA", "Mastitis", "EZFood",  "Pfood", "PSoilP", "PviralDNA", "ZymoDNA"))

```

***
<style>
div.type0 { background-color:#BFBFBF; border-radius: 5px; padding: 20px;}
</style>
<div class = "type0">
<p style="color:black;font-size:15px;"> <b> 
Model not assuming homoscedasticity and including VariableKit + SpikeSet + qPCRefficiency was chosen.<br> qPCRefficiency is forced into all final models </b>

Formula: mod.Salmonella = nlme::gls(LogCopiespermLofMilk ~ VariableKit + qPCRefficiency + SpikeSet, data=Salmonella.InnOnly,
                 weights = varIdent(form = ~1 | VariableKit))<br>
<br>
<b> AIC(mod.Salmonella) <br>
-67.22324 # best model<br>
<br> </b>
 <br>
<br>
Other Models for Reference: <br>
<br>
Formula: mod3.Salmonella = nlme::gls(LogCopiespermLofMilk ~ VariableKit, data=Salmonella.InnOnly,
                 weights = varIdent(form = ~1 | VariableKit))<br>
AIC(mod3.Salmonella) <br>
194.3074<br>
 <br>

Previously chosen Linear Model that assumed homoscedasticity for reference: <br>
Formula: m_Salmonella.LogCopiespermLofMilk3 <- lm( LogCopiespermLofMilk ~ VariableKit + qPCRefficiency + SpikeSet, data=Salmonella.InnOnly ) <br>
AIC(m_Salmonella.LogCopiespermLofMilk3) <br>
17.00478 <br>

</p>
</div>

***


***
<style>
div.type2 { background-color:#66C2A5; border-radius: 15px; padding: 20px;}
</style>
<div class = "type2">
<p style="color:black;font-size:20px;"> <b>Manuscript Figures: Salmonella </b></p>
</div>

***

```{r}
# Salmonella: Milk Data and Controls
Salmonella.Inn.Ctrl <- Salmonella %>% filter(VariableSampleType!="NP40InoculatedMilk")
dim(Salmonella.Inn.Ctrl)

Colors <- c("COREDNA" = "#4DB3C7", "EZFood"= "#85CA46", "Mastitis"= "#F49D00","Pfood"= "#D2338B", "PSoilP"="#1D6E9B", "PviralDNA"= "#6850B4", "ZymoDNA"="#165F05")


Salmonella.Inn.Ctrl$VariableSampleType <- factor(Salmonella.Inn.Ctrl$VariableSampleType, levels=c('InoculatedMilk', 'UninoculatedMilk', 'NoTemplateControl', 'MockCommunity'))

ggplot(data=Salmonella.Inn.Ctrl, aes(VariableKit,LogCopiespermLofMilk, color= VariableKit, shape=SpikeSet))+
  scale_shape_discrete(solid=F) +
  ylab ("Salmonella Log10 Copies / mL of Milk")+  
  xlab ("Kit")+
  geom_point(aes(colour = VariableKit), size = 2, stroke = .5, position=position_jitterdodge(jitter.width=0, dodge.width = 1), show.legend = F) +
  facet_wrap(vars(VariableSampleType),nrow = 1)+
  ggtitle("Salmonella DNA Copy Numbers - All Samples and Controls")+
  theme_bw()+
  ylim(0, 9)+
  scale_color_manual(values=Colors)+
  theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  theme(axis.text.x=element_text(angle=90,vjust=0.5))+
  scale_x_discrete(limits=c("COREDNA", "Mastitis", "EZFood",  "Pfood", "PSoilP", "PviralDNA", "ZymoDNA"))

ggsave("Salmonella-AllSamples.TIFF", width = 9, height = 3,units = "in", dpi = 600)

ggplot(Salmonella.InnOnly, aes(VariableKit,LogCopiespermLofMilk,shape = factor(SpikeSet))) +
  scale_shape_discrete(solid=F) +
  geom_point(aes(colour = VariableKit), size = 2, stroke = 1, position=position_jitterdodge(jitter.width=0, dodge.width = 1)) +
  ylab ("Log10 Copies / mL of Milk")+
  xlab ("Kit")+
  ggtitle("Salmonella DNA Copy Numbers - Inoculated Milk Only")+
  theme_bw()+
  scale_color_manual(values=Colors)+
  theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  theme(axis.text.x=element_text(angle=25,vjust=0.5))+
  scale_x_discrete(limits=c("COREDNA", "Mastitis", "EZFood",  "Pfood", "PSoilP", "PviralDNA", "ZymoDNA"))
```

```{r}
# Plot overlaying model estimates to raw data
mod_df1_Salmonella.rawdata<- Salmonella.InnOnly[c(25,42,4)]

mod_df2_Salmonella.best.model<-emmeans(mod.Salmonella.best,~VariableKit, mode = "df.error") %>%
  summary() %>%
  data.frame()

ggplot() +
  geom_jitter(data=mod_df1_Salmonella.rawdata,aes(x=VariableKit,y=LogCopiespermLofMilk,color=VariableKit, shape=SpikeSet), size = 2,stroke = 1, width = .2 ) +
   scale_shape_discrete(solid=F) +
  scale_color_manual(values=Colors)+
  geom_errorbar(data=mod_df2_Salmonella.best.model,aes(x=VariableKit,ymin=lower.CL,ymax=upper.CL),width=0.3)+  
  geom_point(data=mod_df2_Salmonella.best.model,aes(x=VariableKit,y=emmean,fill=VariableKit))+
  geom_text(data =data.frame(mod.Salmonella.best_cld_letters),aes(x=VariableKit,label=`.group`, y=emmean), nudge_y = 2, nudge_x = -0.05, fontface = "bold") +
#ylim(3.5, 6.5)+
ylab ("Log10 Copies / mL of Milk")+
  xlab ("Kit")+
  ggtitle("Salmonella DNA Copy Numbers - Inoculated Milk Only")+
   theme_bw()+
   theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  scale_x_discrete(limits=c("COREDNA", "Mastitis", "EZFood",  "Pfood", "PSoilP", "PviralDNA", "ZymoDNA"))

ggsave("Salmonella-Model-Jitter.TIFF", width = 7.5, height = 3.5 , units = "in", dpi = 600)


ggplot() +
  geom_point(data=mod_df1_Salmonella.rawdata,aes(x=VariableKit,y=LogCopiespermLofMilk,color=VariableKit, shape=SpikeSet), size = 2, stroke = 1, position=position_jitterdodge(jitter.width=0, dodge.width = .5)) +
   scale_shape_discrete(solid=F) +
  scale_color_manual(values=Colors)+
  geom_errorbar(data=mod_df2_Salmonella.best.model,aes(x=VariableKit,ymin=lower.CL,ymax=upper.CL),width=0.3)+  
  geom_point(data=mod_df2_Salmonella.best.model,aes(x=VariableKit,y=emmean,fill=VariableKit))+
  geom_text(data =data.frame(mod.Salmonella.best_cld_letters),aes(x=VariableKit,label=`.group`, y=emmean), nudge_y = 2, nudge_x = -0.05, fontface = "bold") +
#ylim(3.5, 6.5)+
ylab ("Log10 Copies / mL of Milk")+
  xlab ("Kit")+
  ggtitle("Salmonella DNA Copy Numbers - Inoculated Milk Only")+
   theme_bw()+
   theme(panel.grid.major = element_blank())+
  theme(panel.grid.minor = element_blank())+
  theme(panel.background = element_blank())+
  theme(panel.border = element_blank())+
  theme(axis.line = element_line())+
  scale_x_discrete(limits=c("COREDNA", "Mastitis", "EZFood",  "Pfood", "PSoilP", "PviralDNA", "ZymoDNA"))
ggsave("Salmonella-Model.TIFF", width = 7.5, height = 3.5 , units = "in", dpi = 600)
```

```{r}
sessionInfo()
```